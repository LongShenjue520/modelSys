!function(e){"use strict";e.jgrid.extend({setTreeNode:function(r,t){return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid)for(var d,a,n,s,l,p,o,c,h=i.p.expColInd,f=i.p.treeReader.expanded_field,u=i.p.treeReader.leaf_field,g=i.p.treeReader.level_field,v=i.p.treeReader.icon_field,_=i.p.treeReader.loaded;t>r;){var G,R=i.rows[r].id,j=i.p._index[R];if(o=i.p.data[j],"nested"==i.p.treeGridModel&&(o[u]||(d=parseInt(o[i.p.treeReader.left_field],10),a=parseInt(o[i.p.treeReader.right_field],10),o[u]=a===d+1?"true":"false",i.rows[r].cells[i.p._treeleafpos].innerHTML=o[u])),n=parseInt(o[g],10),0===i.p.tree_root_level?(s=n+1,l=n):(s=n,l=n-1),p="<div class='tree-wrap tree-wrap-"+i.p.direction+"' style='width:"+18*s+"px;'>",p+="<div style='"+("rtl"==i.p.direction?"right:":"left:")+18*l+"px;' class='ui-icon ",void 0!==o[_]&&("true"==o[_]||o[_]===!0?o[_]=!0:o[_]=!1),"true"==o[u]||o[u]===!0?(p+=(void 0!==o[v]&&""!==o[v]?o[v]:i.p.treeIcons.leaf)+" tree-leaf treeclick",o[u]=!0,c="leaf"):(o[u]=!1,c=""),o[f]=("true"==o[f]||o[f]===!0?!0:!1)&&o[_],p+=o[f]===!1?o[u]===!0?"'":i.p.treeIcons.plus+" tree-plus treeclick'":o[u]===!0?"'":i.p.treeIcons.minus+" tree-minus treeclick'",p+="></div></div>",e(i.rows[r].cells[h]).wrapInner("<span class='cell-wrapper"+c+"'></span>").prepend(p),n!==parseInt(i.p.tree_root_level,10)){var I=e(i).jqGrid("getNodeParent",o);G=I&&I.hasOwnProperty(f)?I[f]:!0,G||e(i.rows[r]).css("display","none")}e(i.rows[r].cells[h]).find("div.treeclick").bind("click",function(r){var t=r.target||r.srcElement,d=e(t,i.rows).closest("tr.jqgrow")[0].id,a=i.p._index[d];return i.p.data[a][u]||(i.p.data[a][f]?(e(i).jqGrid("collapseRow",i.p.data[a]),e(i).jqGrid("collapseNode",i.p.data[a])):(e(i).jqGrid("expandRow",i.p.data[a]),e(i).jqGrid("expandNode",i.p.data[a]))),!1}),i.p.ExpandColClick===!0&&e(i.rows[r].cells[h]).find("span.cell-wrapper").css("cursor","pointer").bind("click",function(r){var t=r.target||r.srcElement,d=e(t,i.rows).closest("tr.jqgrow")[0].id,a=i.p._index[d];return i.p.data[a][u]||(i.p.data[a][f]?(e(i).jqGrid("collapseRow",i.p.data[a]),e(i).jqGrid("collapseNode",i.p.data[a])):(e(i).jqGrid("expandRow",i.p.data[a]),e(i).jqGrid("expandNode",i.p.data[a]))),e(i).jqGrid("setSelection",d),!1}),r++}})},setTreeGrid:function(){return this.each(function(){var r,t,i,d=this,a=0,n=!1,s=[];if(d.p.treeGrid){d.p.treedatatype||e.extend(d.p,{treedatatype:d.p.datatype}),d.p.subGrid=!1,d.p.altRows=!1,d.p.pgbuttons=!1,d.p.pginput=!1,d.p.gridview=!0,null===d.p.rowTotal&&(d.p.rowNum=1e4),d.p.multiselect=!1,d.p.rowList=[],d.p.expColInd=0,r="ui-icon-triangle-1-"+("rtl"==d.p.direction?"w":"e"),d.p.treeIcons=e.extend({plus:r,minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},d.p.treeIcons||{}),"nested"==d.p.treeGridModel?d.p.treeReader=e.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},d.p.treeReader):"adjacency"==d.p.treeGridModel&&(d.p.treeReader=e.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},d.p.treeReader));for(i in d.p.colModel)if(d.p.colModel.hasOwnProperty(i)){t=d.p.colModel[i].name,t!=d.p.ExpandColumn||n||(n=!0,d.p.expColInd=a),a++;for(var l in d.p.treeReader)d.p.treeReader[l]==t&&s.push(t)}e.each(d.p.treeReader,function(r,t){t&&-1===e.inArray(t,s)&&("leaf_field"===r&&(d.p._treeleafpos=a),a++,d.p.colNames.push(t),d.p.colModel.push({name:t,width:1,hidden:!0,sortable:!1,resizable:!1,hidedlg:!0,editable:!0,search:!1}))})}})},expandRow:function(r){this.each(function(){var t=this;if(t.grid&&t.p.treeGrid){var i=e(t).jqGrid("getNodeChildren",r),d=t.p.treeReader.expanded_field,a=t.rows;e(i).each(function(){var r=e.jgrid.getAccessor(this,t.p.localReader.id);e(a.namedItem(r)).css("display",""),this[d]&&e(t).jqGrid("expandRow",this)})}})},collapseRow:function(r){this.each(function(){var t=this;if(t.grid&&t.p.treeGrid){var i=e(t).jqGrid("getNodeChildren",r),d=t.p.treeReader.expanded_field,a=t.rows;e(i).each(function(){var r=e.jgrid.getAccessor(this,t.p.localReader.id);e(a.namedItem(r)).css("display","none"),this[d]&&e(t).jqGrid("collapseRow",this)})}})},getRootNodes:function(){var r=[];return this.each(function(){var t=this;if(t.grid&&t.p.treeGrid)switch(t.p.treeGridModel){case"nested":var i=t.p.treeReader.level_field;e(t.p.data).each(function(){parseInt(this[i],10)===parseInt(t.p.tree_root_level,10)&&r.push(this)});break;case"adjacency":var d=t.p.treeReader.parent_id_field;e(t.p.data).each(function(){(null===this[d]||"null"==String(this[d]).toLowerCase())&&r.push(this)})}}),r},getNodeDepth:function(r){var t=null;return this.each(function(){if(this.grid&&this.p.treeGrid){var i=this;switch(i.p.treeGridModel){case"nested":var d=i.p.treeReader.level_field;t=parseInt(r[d],10)-parseInt(i.p.tree_root_level,10);break;case"adjacency":t=e(i).jqGrid("getNodeAncestors",r).length}}}),t},getNodeParent:function(r){var t=null;return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid)switch(i.p.treeGridModel){case"nested":var d=i.p.treeReader.left_field,a=i.p.treeReader.right_field,n=i.p.treeReader.level_field,s=parseInt(r[d],10),l=parseInt(r[a],10),p=parseInt(r[n],10);e(this.p.data).each(function(){return parseInt(this[n],10)===p-1&&parseInt(this[d],10)<s&&parseInt(this[a],10)>l?(t=this,!1):void 0});break;case"adjacency":var o=i.p.treeReader.parent_id_field,c=i.p.localReader.id;e(this.p.data).each(function(){return this[c]==r[o]?(t=this,!1):void 0})}}),t},getNodeChildren:function(r){var t=[];return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid)switch(i.p.treeGridModel){case"nested":var d=i.p.treeReader.left_field,a=i.p.treeReader.right_field,n=i.p.treeReader.level_field,s=parseInt(r[d],10),l=parseInt(r[a],10),p=parseInt(r[n],10);e(this.p.data).each(function(){parseInt(this[n],10)===p+1&&parseInt(this[d],10)>s&&parseInt(this[a],10)<l&&t.push(this)});break;case"adjacency":var o=i.p.treeReader.parent_id_field,c=i.p.localReader.id;e(this.p.data).each(function(){this[o]==r[c]&&t.push(this)})}}),t},getFullTreeNode:function(r){var t=[];return this.each(function(){var i,d=this;if(d.grid&&d.p.treeGrid)switch(d.p.treeGridModel){case"nested":var a=d.p.treeReader.left_field,n=d.p.treeReader.right_field,s=d.p.treeReader.level_field,l=parseInt(r[a],10),p=parseInt(r[n],10),o=parseInt(r[s],10);e(this.p.data).each(function(){parseInt(this[s],10)>=o&&parseInt(this[a],10)>=l&&parseInt(this[a],10)<=p&&t.push(this)});break;case"adjacency":if(r){t.push(r);var c=d.p.treeReader.parent_id_field,h=d.p.localReader.id;e(this.p.data).each(function(e){for(i=t.length,e=0;i>e;e++)if(t[e][h]==this[c]){t.push(this);break}})}}}),t},getNodeAncestors:function(r){var t=[];return this.each(function(){if(this.grid&&this.p.treeGrid)for(var i=e(this).jqGrid("getNodeParent",r);i;)t.push(i),i=e(this).jqGrid("getNodeParent",i)}),t},isVisibleNode:function(r){var t=!0;return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid){var d=e(i).jqGrid("getNodeAncestors",r),a=i.p.treeReader.expanded_field;e(d).each(function(){return t=t&&this[a],t?void 0:!1})}}),t},isNodeLoaded:function(r){var t;return this.each(function(){var i=this;if(i.grid&&i.p.treeGrid){var d=i.p.treeReader.leaf_field;t=void 0!==r?void 0!==r.loaded?r.loaded:r[d]||e(i).jqGrid("getNodeChildren",r).length>0?!0:!1:!1}}),t},expandNode:function(r){return this.each(function(){if(this.grid&&this.p.treeGrid){var t=this.p.treeReader.expanded_field,i=this.p.treeReader.parent_id_field,d=this.p.treeReader.loaded,a=this.p.treeReader.level_field,n=this.p.treeReader.left_field,s=this.p.treeReader.right_field;if(!r[t]){var l=e.jgrid.getAccessor(r,this.p.localReader.id),p=e("#"+e.jgrid.jqID(l),this.grid.bDiv)[0],o=this.p._index[l];e(this).jqGrid("isNodeLoaded",this.p.data[o])?(r[t]=!0,e("div.treeclick",p).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")):this.grid.hDiv.loading||(r[t]=!0,e("div.treeclick",p).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus"),this.p.treeANode=p.rowIndex,this.p.datatype=this.p.treedatatype,"nested"==this.p.treeGridModel?e(this).jqGrid("setGridParam",{postData:{nodeid:l,n_left:r[n],n_right:r[s],n_level:r[a]}}):e(this).jqGrid("setGridParam",{postData:{nodeid:l,parentid:r[i],n_level:r[a]}}),e(this).trigger("reloadGrid"),r[d]=!0,"nested"==this.p.treeGridModel?e(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}}):e(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}}))}}})},collapseNode:function(r){return this.each(function(){if(this.grid&&this.p.treeGrid){var t=this.p.treeReader.expanded_field;if(r[t]){r[t]=!1;var i=e.jgrid.getAccessor(r,this.p.localReader.id),d=e("#"+e.jgrid.jqID(i),this.grid.bDiv)[0];e("div.treeclick",d).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}}})},SortTree:function(r,t,i,d){return this.each(function(){if(this.grid&&this.p.treeGrid){var a,n,s,l,p,o=[],c=this,h=e(this).jqGrid("getRootNodes");for(l=e.jgrid.from(h),l.orderBy(r,t,i,d),p=l.select(),a=0,n=p.length;n>a;a++)s=p[a],o.push(s),e(this).jqGrid("collectChildrenSortTree",o,s,r,t,i,d);e.each(o,function(r){var t=e.jgrid.getAccessor(this,c.p.localReader.id);e("#"+e.jgrid.jqID(c.p.id)+" tbody tr:eq("+r+")").after(e("tr#"+e.jgrid.jqID(t),c.grid.bDiv))}),l=null,p=null,o=null}})},collectChildrenSortTree:function(r,t,i,d,a,n){return this.each(function(){if(this.grid&&this.p.treeGrid){var s,l,p,o,c,h;for(o=e(this).jqGrid("getNodeChildren",t),c=e.jgrid.from(o),c.orderBy(i,d,a,n),h=c.select(),s=0,l=h.length;l>s;s++)p=h[s],r.push(p),e(this).jqGrid("collectChildrenSortTree",r,p,i,d,a,n)}})},setTreeRow:function(r,t){var i=!1;return this.each(function(){var d=this;d.grid&&d.p.treeGrid&&(i=e(d).jqGrid("setRowData",r,t))}),i},delTreeNode:function(r){return this.each(function(){var t,i,d,a,n=this,s=n.p.localReader.id,l=n.p.treeReader.left_field,p=n.p.treeReader.right_field;if(n.grid&&n.p.treeGrid){var o=n.p._index[r];if(void 0!==o){t=parseInt(n.p.data[o][p],10),i=t-parseInt(n.p.data[o][l],10)+1;var c=e(n).jqGrid("getFullTreeNode",n.p.data[o]);if(c.length>0)for(var h=0;h<c.length;h++)e(n).jqGrid("delRowData",c[h][s]);if("nested"===n.p.treeGridModel){if(d=e.jgrid.from(n.p.data).greater(l,t,{stype:"integer"}).select(),d.length)for(a in d)d.hasOwnProperty(a)&&(d[a][l]=parseInt(d[a][l],10)-i);if(d=e.jgrid.from(n.p.data).greater(p,t,{stype:"integer"}).select(),d.length)for(a in d)d.hasOwnProperty(a)&&(d[a][p]=parseInt(d[a][p],10)-i)}}}})},addChildNode:function(r,t,i){var d=this[0];if(i){var a,n,s,l,p,o,c,h,f=d.p.treeReader.expanded_field,u=d.p.treeReader.leaf_field,g=d.p.treeReader.level_field,v=d.p.treeReader.parent_id_field,_=d.p.treeReader.left_field,G=d.p.treeReader.right_field,R=d.p.treeReader.loaded,j=0,I=t;if("undefined"==typeof r||null===r){if(p=d.p.data.length-1,p>=0)for(;p>=0;)j=Math.max(j,parseInt(d.p.data[p][d.p.localReader.id],10)),p--;r=j+1}var w=e(d).jqGrid("getInd",t);if(c=!1,void 0===t||null===t||""===t)t=null,I=null,a="last",l=d.p.tree_root_level,p=d.p.data.length+1;else{a="after",n=d.p._index[t],s=d.p.data[n],t=s[d.p.localReader.id],l=parseInt(s[g],10)+1;var q=e(d).jqGrid("getFullTreeNode",s);q.length?(p=q[q.length-1][d.p.localReader.id],I=p,p=e(d).jqGrid("getInd",I)+1):p=e(d).jqGrid("getInd",t)+1,s[u]&&(c=!0,s[f]=!0,e(d.rows[w]).find("span.cell-wrapperleaf").removeClass("cell-wrapperleaf").addClass("cell-wrapper").end().find("div.tree-leaf").removeClass(d.p.treeIcons.leaf+" tree-leaf").addClass(d.p.treeIcons.minus+" tree-minus"),d.p.data[n][u]=!1,s[R]=!0)}if(o=p+1,i[f]=!1,i[R]=!0,i[g]=l,i[u]=!0,"adjacency"===d.p.treeGridModel&&(i[v]=t),"nested"===d.p.treeGridModel){var m,x,y;if(null!==t){if(h=parseInt(s[G],10),m=e.jgrid.from(d.p.data),m=m.greaterOrEquals(G,h,{stype:"integer"}),x=m.select(),x.length)for(y in x)x.hasOwnProperty(y)&&(x[y][_]=x[y][_]>h?parseInt(x[y][_],10)+2:x[y][_],x[y][G]=x[y][G]>=h?parseInt(x[y][G],10)+2:x[y][G]);i[_]=h,i[G]=h+1}else{if(h=parseInt(e(d).jqGrid("getCol",G,!1,"max"),10),x=e.jgrid.from(d.p.data).greater(_,h,{stype:"integer"}).select(),x.length)for(y in x)x.hasOwnProperty(y)&&(x[y][_]=parseInt(x[y][_],10)+2);if(x=e.jgrid.from(d.p.data).greater(G,h,{stype:"integer"}).select(),x.length)for(y in x)x.hasOwnProperty(y)&&(x[y][G]=parseInt(x[y][G],10)+2);i[_]=h+1,i[G]=h+2}}(null===t||e(d).jqGrid("isNodeLoaded",s)||c)&&(e(d).jqGrid("addRowData",r,i,a,I),e(d).jqGrid("setTreeNode",p,o)),s&&!s[f]&&e(d.rows[w]).find("div.treeclick").click()}}})}(jQuery);