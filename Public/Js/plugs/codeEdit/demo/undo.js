function UndoHistory(t,i,o,e){this.container=t,this.maxDepth=i,this.commitDelay=o,this.editor=e;var r={text:"",from:null,to:null};this.first=r,this.last=r,this.firstTouched=!1,this.history=[],this.redoHistory=[],this.touched=[],this.lostundo=0}UndoHistory.prototype={scheduleCommit:function(){var t=this;parent.clearTimeout(this.commitTimeout),this.commitTimeout=parent.setTimeout(function(){t.tryCommit()},this.commitDelay)},touch:function(t){this.setTouched(t),this.scheduleCommit()},undo:function(){if(this.commit(),this.history.length){var t=this.history.pop();return this.redoHistory.push(this.updateTo(t,"applyChain")),this.notifyEnvironment(),this.chainNode(t)}},redo:function(){if(this.commit(),this.redoHistory.length){var t=this.redoHistory.pop();return this.addUndoLevel(this.updateTo(t,"applyChain")),this.notifyEnvironment(),this.chainNode(t)}},clear:function(){this.history=[],this.redoHistory=[],this.lostundo=0},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length,lostundo:this.lostundo}},push:function(t,i,o){for(var e=[],r=0;r<o.length;r++){var n=r==o.length-1?i:document.createElement("br");e.push({from:t,to:n,text:cleanText(o[r])}),t=n}this.pushChains([e],null==t&&null==i),this.notifyEnvironment()},pushChains:function(t,i){this.commit(i),this.addUndoLevel(this.updateTo(t,"applyChain")),this.redoHistory=[]},chainNode:function(t){for(var i=0;i<t.length;i++){var o=t[i][0],e=o&&(o.from||o.to);if(e)return e}},reset:function(){this.history=[],this.redoHistory=[],this.lostundo=0},textAfter:function(t){return this.after(t).text},nodeAfter:function(t){return this.after(t).to},nodeBefore:function(t){return this.before(t).from},tryCommit:function(){window&&window.parent&&window.UndoHistory&&(this.editor.highlightDirty()?this.commit(!0):this.scheduleCommit())},commit:function(t){parent.clearTimeout(this.commitTimeout),t||this.editor.highlightDirty(!0);var i=this.touchedChains();i.length&&(this.addUndoLevel(this.updateTo(i,"linkChain")),this.redoHistory=[],this.notifyEnvironment())},updateTo:function(t,i){for(var o=[],e=[],r=0;r<t.length;r++)o.push(this.shadowChain(t[r])),e.push(this[i](t[r]));return"applyChain"==i&&this.notifyDirty(e),o},notifyDirty:function(t){forEach(t,method(this.editor,"addDirtyNode")),this.editor.scheduleHighlight()},notifyEnvironment:function(){this.onChange&&this.onChange(this.editor),window.frameElement&&window.frameElement.CodeMirror.updateNumbers&&window.frameElement.CodeMirror.updateNumbers()},linkChain:function(t){for(var i=0;i<t.length;i++){var o=t[i];o.from?o.from.historyAfter=o:this.first=o,o.to?o.to.historyBefore=o:this.last=o}},after:function(t){return t?t.historyAfter:this.first},before:function(t){return t?t.historyBefore:this.last},setTouched:function(t){t?t.historyTouched||(this.touched.push(t),t.historyTouched=!0):this.firstTouched=!0},addUndoLevel:function(t){this.history.push(t),this.history.length>this.maxDepth&&(this.history.shift(),this.lostundo+=1)},touchedChains:function(){function t(t){return t?t.historyTemp:n}function i(t,i){t?t.historyTemp=i:n=i}function o(t){for(var i=[],o=t?t.nextSibling:r.container.firstChild;o&&(!isBR(o)||o.hackBR);o=o.nextSibling)!o.hackBR&&o.currentText&&i.push(o.currentText);return{from:t,to:o,text:cleanText(i.join(""))}}function e(t,i){for(var o=i+"Sibling",e=t[o];e&&!isBR(e);)e=e[o];return e}var r=this,n=null,h=[];r.firstTouched&&r.touched.push(null),forEach(r.touched,function(t){if(!t||t.parentNode==r.container&&!t.hackBR){t?t.historyTouched=!1:r.firstTouched=!1;var e=o(t),n=r.after(t);n&&n.text==e.text&&n.to==e.to||(h.push(e),i(t,e))}});var s=[];return r.touched=[],forEach(h,function(n){if(t(n.from)){for(var h=[],f=n.from,a=!0;;){var u=t(f);if(!u){if(a)break;u=o(f)}if(h.unshift(u),i(f,null),!f)break;a=r.after(f),f=e(f,"previous")}for(f=n.to,a=r.before(n.from);;){if(!f)break;var u=t(f);if(!u){if(a)break;u=o(f)}h.push(u),i(f,null),a=r.before(f),f=e(f,"next")}s.push(h)}}),s},shadowChain:function(t){for(var i=[],o=this.after(t[0].from),e=t[t.length-1].to;;){i.push(o);var r=o.to;if(!r||r==e)break;o=r.historyAfter||this.before(e)}return i},applyChain:function(t){function i(t,i){for(var o=t?t.nextSibling:e.container.firstChild;o!=i;){var r=o.nextSibling;removeElement(o),o=r}}var o=select.cursorPos(this.container,!1),e=this,r=t[0].from,n=t[t.length-1].to;i(r,n);for(var h=0;h<t.length;h++){var s=t[h];h>0&&e.container.insertBefore(s.from,n);var f=makePartSpan(fixSpaces(s.text));if(e.container.insertBefore(f,n),o&&o.node==s.from){var a=0,u=this.after(s.from);if(u&&h==t.length-1){for(var c=0;c<o.offset&&s.text.charAt(c)==u.text.charAt(c);c++);o.offset>c&&(a=s.text.length-u.text.length)}select.setCursorPos(this.container,{node:s.from,offset:Math.max(0,o.offset+a)})}else o&&h==t.length-1&&o.node&&o.node.parentNode!=this.container&&select.setCursorPos(this.container,{node:s.from,offset:s.text.length})}return this.linkChain(t),r}};