!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(e){"use strict";function o(e,o){var t;return"string"==typeof e?(t=e.charAt(0),e=new RegExp("^"+e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),o?"i":"")):e=new RegExp("^(?:"+e.source+")",e.ignoreCase?"i":""),{token:function(n){if(n.match(e))return"searching";for(;!n.eol()&&(n.next(),t&&!o&&(n.skipTo(t)||n.skipToEnd()),!n.match(e,!1)););}}}function t(){this.posFrom=this.posTo=this.query=null,this.overlay=null}function n(e){return e.state.search||(e.state.search=new t)}function r(e){return"string"==typeof e&&e==e.toLowerCase()}function i(e,o,t){return e.getSearchCursor(o,t,r(o))}function c(e,o,t,n,r){e.openDialog?e.openDialog(o,r,{value:n}):r(prompt(t,n))}function a(e,o,t,n){e.openConfirm?e.openConfirm(o,n):confirm(t)&&n[0]()}function u(e){var o=e.match(/^\/(.*)\/([a-z]*)$/);return o?(e=new RegExp(o[1],-1==o[2].indexOf("i")?"":"i"),e.test("")&&(e=/x^/)):""==e&&(e=/x^/),e}function f(e,t){var i=n(e);return i.query?s(e,t):void c(e,m,"Search for:",e.getSelection(),function(n){e.operation(function(){n&&!i.query&&(i.query=u(n),e.removeOverlay(i.overlay,r(i.query)),i.overlay=o(i.query,r(i.query)),e.addOverlay(i.overlay),i.posFrom=i.posTo=e.getCursor(),s(e,t))})})}function s(o,t){o.operation(function(){var r=n(o),c=i(o,r.query,t?r.posFrom:r.posTo);(c.find(t)||(c=i(o,r.query,t?e.Pos(o.lastLine()):e.Pos(o.firstLine(),0)),c.find(t)))&&(o.setSelection(c.from(),c.to()),o.scrollIntoView({from:c.from(),to:c.to()}),r.posFrom=c.from(),r.posTo=c.to())})}function l(e){e.operation(function(){var o=n(e);o.query&&(o.query=null,e.removeOverlay(o.overlay))})}function p(e,o){c(e,d,"Replace:",e.getSelection(),function(t){t&&(t=u(t),c(e,y,"Replace with:","",function(n){if(o)e.operation(function(){for(var o=i(e,t);o.findNext();)if("string"!=typeof t){var r=e.getRange(o.from(),o.to()).match(t);o.replace(n.replace(/\$(\d)/g,function(e,o){return r[o]}))}else o.replace(n)});else{l(e);var r=i(e,t,e.getCursor()),c=function(){var o,n=r.from();!(o=r.findNext())&&(r=i(e,t),!(o=r.findNext())||n&&r.from().line==n.line&&r.from().ch==n.ch)||(e.setSelection(r.from(),r.to()),e.scrollIntoView({from:r.from(),to:r.to()}),a(e,g,"Replace?",[function(){u(o)},c]))},u=function(e){r.replace("string"==typeof t?n:n.replace(/\$(\d)/g,function(o,t){return e[t]})),c()};c()}}))})}var m='Search: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',d='Replace: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',y='With: <input type="text" style="width: 10em"/>',g="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";e.commands.find=function(e){l(e),f(e)},e.commands.findNext=f,e.commands.findPrev=function(e){f(e,!0)},e.commands.clearSearch=l,e.commands.replace=p,e.commands.replaceAll=function(e){p(e,!0)}});