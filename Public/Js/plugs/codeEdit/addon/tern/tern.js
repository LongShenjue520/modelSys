!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t,n){var o=e.docs[t];o?n(F(e,o)):e.options.getFile?e.options.getFile(t,n):n(null)}function n(e,t,n){for(var o in e.docs){var r=e.docs[o];if(r.doc==t)return r}if(!n)for(var i=0;;++i)if(o="[doc"+(i||"")+"]",!e.docs[o]){n=o;break}return e.addDoc(n,t)}function o(e,t,o){var i=n(e,t),a=e.cachedArgHints;a&&a.doc==t&&O(a.start,o.to)<=0&&(e.cachedArgHints=null);var s=i.changed;null==s&&(i.changed=s={from:o.from.line,to:o.from.line});var c=o.from.line+(o.text.length-1);o.from.line<s.to&&(s.to=s.to-(o.to.line-c)),c>=s.to&&(s.to=c+1),s.from>o.from.line&&(s.from=o.from.line),t.lineCount()>j&&o.to-s.from>100&&setTimeout(function(){i.changed&&i.changed.to-i.changed.from>100&&r(e,i)},200)}function r(e,t){e.server.request({files:[{type:"full",name:t.name,text:F(e,t)}]},function(e){e?window.console.error(e):t.changed=null})}function i(t,n,o){t.request(n,{type:"completions",types:!0,docs:!0,urls:!0},function(r,i){if(r)return D(t,n,r);var s=[],c="",l=i.start,u=i.end;'["'==n.getRange(q(l.line,l.ch-2),l)&&'"]'!=n.getRange(u,q(u.line,u.ch+2))&&(c='"]');for(var f=0;f<i.completions.length;++f){var d=i.completions[f],p=a(d.type);i.guess&&(p+=" "+M+"guess"),s.push({text:d.name+c,displayText:d.name,className:p,data:d})}var h={from:l,to:u,list:s},g=null;e.on(h,"close",function(){k(g)}),e.on(h,"update",function(){k(g)}),e.on(h,"select",function(e,n){k(g);var o=t.options.completionTip?t.options.completionTip(e.data):e.data.doc;o&&(g=A(n.parentNode.getBoundingClientRect().right+window.pageXOffset,n.getBoundingClientRect().top+window.pageYOffset,o),g.className+=" "+M+"hint-doc")}),o(h)})}function a(e){var t;return t="?"==e?"unknown":"number"==e||"string"==e||"bool"==e?e:/^fn\(/.test(e)?"fn":/^\[/.test(e)?"array":"object",M+"completion "+M+"completion-"+t}function s(e,t,n){e.request(t,"type",function(n,o){if(n)return D(e,t,n);if(e.options.typeTip)var r=e.options.typeTip(o);else{var r=b("span",null,b("strong",null,o.type||"not found"));o.doc&&r.appendChild(document.createTextNode(" — "+o.doc)),o.url&&(r.appendChild(document.createTextNode(" ")),r.appendChild(b("a",null,"[docs]")).href=o.url)}T(t,r)},n)}function c(t,n){if(S(t),!n.somethingSelected()){var o=n.getTokenAt(n.getCursor()).state,r=e.innerMode(n.getMode(),o);if("javascript"==r.mode.name){var i=r.state.lexical;if("call"==i.info){for(var a,s=i.pos||0,c=n.getOption("tabSize"),f=n.getCursor().line,d=Math.max(0,f-9),p=!1;f>=d;--f){for(var h=n.getLine(f),g=0,m=0;;){var v=h.indexOf("	",m);if(-1==v)break;g+=c-(v+g)%c-1,m=v+1}if(a=i.column-g,"("==h.charAt(a)){p=!0;break}}if(p){var y=q(f,a),C=t.cachedArgHints;return C&&C.doc==n.getDoc()&&0==O(y,C.start)?l(t,n,s):void t.request(n,{type:"type",preferFunction:!0,end:y},function(e,o){!e&&o.type&&/^fn\(/.test(o.type)&&(t.cachedArgHints={start:m,type:u(o.type),name:o.exprName||o.name||"fn",guess:o.guess,doc:n.getDoc()},l(t,n,s))})}}}}}function l(e,t,n){S(e);for(var o=e.cachedArgHints,r=o.type,i=b("span",o.guess?M+"fhint-guess":null,b("span",M+"fname",o.name),"("),a=0;a<r.args.length;++a){a&&i.appendChild(document.createTextNode(", "));var s=r.args[a];i.appendChild(b("span",M+"farg"+(a==n?" "+M+"farg-current":""),s.name||"?")),"?"!=s.type&&(i.appendChild(document.createTextNode(": ")),i.appendChild(b("span",M+"type",s.type)))}i.appendChild(document.createTextNode(r.rettype?") -> ":")")),r.rettype&&i.appendChild(b("span",M+"type",r.rettype));var c=t.cursorCoords(null,"page");e.activeArgHints=A(c.right+1,c.bottom,i)}function u(e){function t(t){for(var n=0,r=o;;){var i=e.charAt(o);if(t.test(i)&&!n)return e.slice(r,o);/[{\[\(]/.test(i)?++n:/[}\]\)]/.test(i)&&--n,++o}}var n=[],o=3;if(")"!=e.charAt(o))for(;;){var r=e.slice(o).match(/^([^, \(\[\{]+): /);if(r&&(o+=r[0].length,r=r[1]),n.push({name:r,type:t(/[\),]/)}),")"==e.charAt(o))break;o+=2}var i=e.slice(o).match(/^\) -> (.*)$/);return{args:n,rettype:i&&i[1]}}function f(e,t){function o(o){var r={type:"definition",variable:o||null},i=n(e,t.getDoc());e.server.request(C(e,i,r),function(n,o){if(n)return D(e,t,n);if(!o.file&&o.url)return void window.open(o.url);if(o.file){var r,a=e.docs[o.file];if(a&&(r=h(a.doc,o)))return e.jumpStack.push({file:i.name,start:t.getCursor("from"),end:t.getCursor("to")}),void p(e,i,a,r.start,r.end)}D(e,t,"Could not find a definition.")})}g(t)?o():w(t,"Jump to variable",function(e){e&&o(e)})}function d(e,t){var o=e.jumpStack.pop(),r=o&&e.docs[o.file];r&&p(e,n(e,t.getDoc()),r,o.start,o.end)}function p(e,t,n,o,r){n.doc.setSelection(r,o),t!=n&&e.options.switchToDoc&&(S(e),e.options.switchToDoc(n.name))}function h(e,t){for(var n=t.context.slice(0,t.contextOffset).split("\n"),o=t.start.line-(n.length-1),r=q(o,(1==n.length?t.start.ch:e.getLine(o).length)-n[0].length),i=e.getLine(o).slice(r.ch),a=o+1;a<e.lineCount()&&i.length<t.context.length;++a)i+="\n"+e.getLine(a);if(i.slice(0,t.context.length)==t.context)return t;for(var s,c=e.getSearchCursor(t.context,0,!1),l=1/0;c.findNext();){var u=c.from(),f=1e4*Math.abs(u.line-r.line);f||(f=Math.abs(u.ch-r.ch)),l>f&&(s=u,l=f)}if(!s)return null;if(1==n.length?s.ch+=n[0].length:s=q(s.line+(n.length-1),n[n.length-1].length),t.start.line==t.end.line)var d=q(s.line,s.ch+(t.end.ch-t.start.ch));else var d=q(s.line+(t.end.line-t.start.line),t.end.ch);return{start:s,end:d}}function g(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return n.start<t.ch&&("comment"==n.type||"string"==n.type)?!1:/\w/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function m(e,t){var n=t.getTokenAt(t.getCursor());/\w/.test(n.string)||D(e,t,"Not at a variable"),w(t,"New name for "+n.string,function(n){e.request(t,{type:"rename",newName:n,fullDocs:!0},function(n,o){return n?D(e,t,n):void y(e,o.changes)})})}function v(e,t){var o=t.getCursor(),r=t.getTokenAt(o);/\w/.test(r.string)||D(e,t,"Not at a variable");var i=n(e,t.doc).name;e.request(t,{type:"refs"},function(n,o){if(n)return D(e,t,n);for(var r=[],a=0,s=0;s<o.refs.length;s++){var c=o.refs[s];c.file==i&&(r.push({anchor:c.start,head:c.end}),O(a,c.start)>=0&&O(a,c.end)<=0&&(a=r.length-1))}t.setSelections(r,a)})}function y(e,t){for(var n=Object.create(null),o=0;o<t.length;++o){var r=t[o];(n[r.file]||(n[r.file]=[])).push(r)}for(var i in n){var a=e.docs[i],s=n[i];if(a){s.sort(function(e,t){return O(t.start,e.start)});for(var c="*rename"+ ++L,o=0;o<s.length;++o){var r=s[o];a.doc.replaceRange(r.text,r.start,r.end,c)}}}}function C(e,t,n,o){var r=[],i=0,a=!n.fullDocs;a||delete n.fullDocs,"string"==typeof n&&(n={type:n}),n.lineCharPositions=!0,null==n.end&&(n.end=o||t.doc.getCursor("end"),t.doc.somethingSelected()&&(n.start=t.doc.getCursor("start")));var s=n.start||n.end;if(t.changed)if(t.doc.lineCount()>j&&a!==!1&&t.changed.to-t.changed.from<100&&t.changed.from<=s.line&&t.changed.to>n.end.line){r.push(x(t,s,n.end)),n.file="#0";var i=r[0].offsetLines;null!=n.start&&(n.start=q(n.start.line- -i,n.start.ch)),n.end=q(n.end.line-i,n.end.ch)}else r.push({type:"full",name:t.name,text:F(e,t)}),n.file=t.name,t.changed=null;else n.file=t.name;for(var c in e.docs){var l=e.docs[c];l.changed&&l!=t&&(r.push({type:"full",name:l.name,text:F(e,l)}),l.changed=null)}return{query:n,files:r}}function x(t,n,o){for(var r,i=t.doc,a=null,s=null,c=4,l=n.line-1,u=Math.max(0,l-50);l>=u;--l){var f=i.getLine(l),d=f.search(/\bfunction\b/);if(!(0>d)){var p=e.countColumn(f,null,c);null!=a&&p>=a||(a=p,s=l)}}null==s&&(s=u);var h=Math.min(i.lastLine(),o.line+20);if(null==a||a==e.countColumn(i.getLine(n.line),null,c))r=h;else for(r=o.line+1;h>r;++r){var p=e.countColumn(i.getLine(r),null,c);if(a>=p)break}var g=q(s,0);return{type:"part",name:t.name,offsetLines:g.line,text:i.getRange(g,q(r,0))}}function b(e,t){var n=document.createElement(e);t&&(n.className=t);for(var o=2;o<arguments.length;++o){var r=arguments[o];"string"==typeof r&&(r=document.createTextNode(r)),n.appendChild(r)}return n}function w(e,t,n){e.openDialog?e.openDialog(t+": <input type=text>",n):n(prompt(t,""))}function T(e,t){function n(){r.parentNode&&(e.off("cursorActivity",n),N(r))}var o=e.cursorCoords(),r=A(o.right+1,o.bottom,t);setTimeout(n,1700),e.on("cursorActivity",n)}function A(e,t,n){var o=b("div",M+"tooltip",n);return o.style.left=e+"px",o.style.top=t+"px",document.body.appendChild(o),o}function k(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function N(e){e.style.opacity="0",setTimeout(function(){k(e)},1100)}function D(e,t,n){e.options.showError?e.options.showError(t,n):T(t,String(n))}function S(e){e.activeArgHints&&(k(e.activeArgHints),e.activeArgHints=null)}function F(e,t){var n=t.doc.getValue();return e.options.fileFilter&&(n=e.options.fileFilter(n,t.name,t.doc)),n}function H(e){function n(e,t){t&&(e.id=++r,i[r]=t),o.postMessage(e)}var o=new Worker(e.options.workerScript);o.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps});var r=0,i={};o.onmessage=function(o){var r=o.data;"getFile"==r.type?t(e,r.name,function(e,t){n({type:"getFile",err:String(e),text:t,id:r.id})}):"debug"==r.type?window.console.log(r.message):r.id&&i[r.id]&&(i[r.id](r.err,r.body),delete i[r.id])},o.onerror=function(e){for(var t in i)i[t](e);i={}},this.addFile=function(e,t){n({type:"add",name:e,text:t})},this.delFile=function(e){n({type:"del",name:e})},this.request=function(e,t){n({type:"req",body:e},t)}}e.TernServer=function(e){var n=this;this.options=e||{};var r=this.options.plugins||(this.options.plugins={});r.doc_comment||(r.doc_comment=!0),this.options.useWorker?this.server=new H(this):this.server=new tern.Server({getFile:function(e,o){return t(n,e,o)},async:!0,defs:this.options.defs||[],plugins:r}),this.docs=Object.create(null),this.trackChange=function(e,t){o(n,e,t)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[]},e.TernServer.prototype={addDoc:function(t,n){var o={doc:n,name:t,changed:null};return this.server.addFile(t,F(this,o)),e.on(n,"change",this.trackChange),this.docs[t]=o},delDoc:function(t){var n=this.docs[t];n&&(e.off(n.doc,"change",this.trackChange),delete this.docs[t],this.server.delFile(t))},hideDoc:function(e){S(this);var t=this.docs[e];t&&t.changed&&r(this,t)},complete:function(t){var n=this;e.showHint(t,function(e,t){return i(n,e,t)},{async:!0})},getHint:function(e,t){return i(this,e,t)},showType:function(e,t){s(this,e,t)},updateArgHints:function(e){c(this,e)},jumpToDef:function(e){f(this,e)},jumpBack:function(e){d(this,e)},rename:function(e){m(this,e)},selectName:function(e){v(this,e)},request:function(e,t,o,r){var i=this,a=n(this,e.getDoc()),s=C(this,a,t,r);this.server.request(s,function(e,n){!e&&i.options.responseFilter&&(n=i.options.responseFilter(a,t,s,e,n)),o(e,n)})}};var q=e.Pos,M="CodeMirror-Tern-",j=250,L=0,O=e.cmpPos});