function GanttMaster(){this.tasks=[],this.deletedTaskIds=[],this.links=[],this.editor,this.gantt,this.splitter,this.element,this.resources,this.roles,this.minEditableDate=0,this.maxEditableDate=1/0,this.canWriteOnParent=!0,this.canWrite=!0,this.firstDayOfWeek=Date.firstDayOfWeek,this.currentTask,this.resourceUrl="res/",this.__currentTransaction,this.__undoStack=[],this.__redoStack=[],this.__inUndoRedo=!1}GanttMaster.prototype.init=function(t){this.element=t;var e=this;$("#gantEditorTemplates").loadTemplates().remove(),this.editor=new GridEditor(this),t.append(this.editor.gridified),this.gantt=new Ganttalendar("m",(new Date).getTime()-1728e5,(new Date).getTime()+1296e6,this,.6*t.width()),e.splitter=$.splittify.init(t,this.editor.gridified,this.gantt.element,60),e.splitter.firstBoxMinWidth=30,t.bind("refreshTasks.gantt",function(){e.redrawTasks()}).bind("refreshTask.gantt",function(t,n){e.drawTask(n)}).bind("deleteCurrentTask.gantt",function(t){e.deleteCurrentTask()}).bind("addAboveCurrentTask.gantt",function(){e.addAboveCurrentTask()}).bind("addBelowCurrentTask.gantt",function(){e.addBelowCurrentTask()}).bind("indentCurrentTask.gantt",function(){e.indentCurrentTask()}).bind("outdentCurrentTask.gantt",function(){e.outdentCurrentTask()}).bind("moveUpCurrentTask.gantt",function(){e.moveUpCurrentTask()}).bind("moveDownCurrentTask.gantt",function(){e.moveDownCurrentTask()}).bind("zoomPlus.gantt",function(){e.gantt.zoomGantt(!0)}).bind("zoomMinus.gantt",function(){e.gantt.zoomGantt(!1)}).bind("undo.gantt",function(){e.canWrite&&e.undo()}).bind("redo.gantt",function(){e.canWrite&&e.redo()}).bind("resize.gantt",function(){e.resize()}),$("body").bind("keydown.body",function(t){if("body"==t.target.nodeName.toLowerCase()||"svg"==t.target.nodeName.toLowerCase()){var n=!0;switch(t.keyCode){case 46:case 8:var r=e.gantt.element.find(".focused.focused");r.is(".taskBox")?e.deleteCurrentTask():r.is(".linkGroup")&&e.removeLink(r.data("from"),r.data("to"));break;case 38:e.currentTask&&(e.currentTask.ganttElement.is(".focused")?(e.moveUpCurrentTask(),e.gantt.element.oneTime(100,function(){e.currentTask.ganttElement.addClass("focused")})):e.currentTask.rowElement.prev().click());break;case 40:e.currentTask&&(e.currentTask.ganttElement.is(".focused")?(e.moveDownCurrentTask(),e.gantt.element.oneTime(100,function(){e.currentTask.ganttElement.addClass("focused")})):e.currentTask.rowElement.next().click());break;case 39:e.currentTask&&e.currentTask.ganttElement.is(".focused")&&(e.indentCurrentTask(),e.gantt.element.oneTime(100,function(){e.currentTask.ganttElement.addClass("focused")}));break;case 37:e.currentTask&&e.currentTask.ganttElement.is(".focused")&&(e.outdentCurrentTask(),e.gantt.element.oneTime(100,function(){e.currentTask.ganttElement.addClass("focused")}));break;case 89:t.ctrlKey&&e.redo();break;case 90:t.ctrlKey&&e.undo();break;default:n=!1}n&&(t.preventDefault(),t.stopPropagation())}})},GanttMaster.messages={CANNOT_WRITE:"CANNOT_WRITE",CHANGE_OUT_OF_SCOPE:"NO_RIGHTS_FOR_UPDATE_PARENTS_OUT_OF_EDITOR_SCOPE",START_IS_MILESTONE:"START_IS_MILESTONE",END_IS_MILESTONE:"END_IS_MILESTONE",TASK_HAS_CONSTRAINTS:"TASK_HAS_CONSTRAINTS",GANTT_ERROR_DEPENDS_ON_OPEN_TASK:"GANTT_ERROR_DEPENDS_ON_OPEN_TASK",GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK:"GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK",TASK_HAS_EXTERNAL_DEPS:"TASK_HAS_EXTERNAL_DEPS",GANTT_ERROR_LOADING_DATA_TASK_REMOVED:"GANTT_ERROR_LOADING_DATA_TASK_REMOVED",CIRCULAR_REFERENCE:"CIRCULAR_REFERENCE",ERROR_SETTING_DATES:"ERROR_SETTING_DATES",CANNOT_DEPENDS_ON_ANCESTORS:"CANNOT_DEPENDS_ON_ANCESTORS",CANNOT_DEPENDS_ON_DESCENDANTS:"CANNOT_DEPENDS_ON_DESCENDANTS",INVALID_DATE_FORMAT:"INVALID_DATE_FORMAT",GANTT_QUARTER_SHORT:"GANTT_QUARTER_SHORT",GANTT_SEMESTER_SHORT:"GANTT_SEMESTER_SHORT",CANNOT_CLOSE_TASK_IF_OPEN_ISSUE:"CANNOT_CLOSE_TASK_IF_OPEN_ISSUE"},GanttMaster.prototype.createTask=function(t,e,n,r,s,a){var i=new TaskFactory;return i.build(t,e,n,r,s,a)},GanttMaster.prototype.createResource=function(t,e){var n=new Resource(t,e);return n},GanttMaster.prototype.updateDependsStrings=function(){for(var t=0;t<this.tasks.length;t++)this.tasks[t].depends="";for(var t=0;t<this.links.length;t++){var e=this.links[t];e.to.depends;e.to.depends=e.to.depends+(""==e.to.depends?"":",")+(e.from.getRow()+1)+(e.lag?":"+e.lag:"")}},GanttMaster.prototype.removeLink=function(t,e){if(this.canWrite&&(t.canWrite||e.canWrite)){this.beginTransaction();for(var n=!1,r=0;r<this.links.length;r++)if(this.links[r].from==t&&this.links[r].to==e){this.links.splice(r,1),n=!0;break}n&&(this.updateDependsStrings(),this.updateLinks(e)&&this.changeTaskDates(e,e.start,e.end)),this.endTransaction()}},GanttMaster.prototype.removeAllLinks=function(t,e){if(this.canWrite&&(t.canWrite||t.canWrite)){e&&this.beginTransaction();for(var n=!1,r=0;r<this.links.length;r++)(this.links[r].from==t||this.links[r].to==t)&&(this.links.splice(r,1),n=!0);n&&this.updateDependsStrings(),e&&this.endTransaction()}},GanttMaster.prototype.addTask=function(t,e){t.master=this;for(var n=-1,r=0;r<this.tasks.length;r++)if(t.id==this.tasks[r].id){n=r;break}n>=0&&(this.tasks.splice(n,1),e=parseInt(n)),"number"!=typeof e?this.tasks.push(t):(this.tasks.splice(e,0,t),this.updateDependsStrings());var s=!this.updateLinks(t);t.getParent()?t.status=t.getParent().status:t.status="STATUS_ACTIVE";var a=t;return s||!t.setPeriod(t.start,t.end)?(this.tasks.splice(t.getRow(),1),a=void 0):(this.editor.addTask(t,e),this.gantt.addTask(t)),a},GanttMaster.prototype.loadProject=function(t){this.beginTransaction(),this.resources=t.resources,this.roles=t.roles,this.canWrite=t.canWrite,this.canWriteOnParent=t.canWriteOnParent,this.cannotCloseTaskIfIssueOpen=t.cannotCloseTaskIfIssueOpen,t.minEditableDate?this.minEditableDate=computeStart(t.minEditableDate):this.minEditableDate=-(1/0),t.maxEditableDate?this.maxEditableDate=computeEnd(t.maxEditableDate):this.maxEditableDate=1/0,this.loadTasks(t.tasks,t.selectedRow),this.deletedTaskIds=[],t.splitterPosition&&this.splitter.resize(t.splitterPosition),t.zoom&&(this.gantt.zoom=t.zoom),this.endTransaction();var e=this;this.gantt.element.oneTime(200,function(){e.gantt.centerOnToday()})},GanttMaster.prototype.loadTasks=function(t,e){var n=new TaskFactory;this.reset();for(var r=0;r<t.length;r++){var s=t[r];if(!(s instanceof Task)){var a=n.build(s.id,s.name,s.code,s.level,s.start,s.duration,s.collapsed);for(var i in s)"end"!=i&&"start"!=i&&(a[i]=s[i]);s=a}s.master=this,this.tasks.push(s)}for(var r=0;r<this.tasks.length;r++){for(var s=this.tasks[r],o=this.__currentTransaction&&this.__currentTransaction.errors?this.__currentTransaction.errors.length:0;!this.updateLinks(s);){if(this.__currentTransaction&&o!=this.__currentTransaction.errors.length){for(var c="";o<this.__currentTransaction.errors.length;){var d=this.__currentTransaction.errors.pop();c=c+d.msg+"\n\n"}alert(c)}this.removeAllLinks(s,!1)}s.setPeriod(s.start,s.end)?(this.editor.addTask(s,null,!0),this.gantt.addTask(s)):(alert(GanttMaster.messages.GANNT_ERROR_LOADING_DATA_TASK_REMOVED+"\n"+s.name+"\n"+GanttMaster.messages.ERROR_SETTING_DATES),this.tasks.splice(s.getRow(),1))}this.editor.fillEmptyLines(),this.tasks&&this.tasks.length>0&&(e=e?e:0,this.tasks[e].rowElement.click())},GanttMaster.prototype.getTask=function(t){for(var e,n=0;n<this.tasks.length;n++){var r=this.tasks[n];if(r.id==t){e=r;break}}return e},GanttMaster.prototype.getResource=function(t){for(var e,n=0;n<this.resources.length;n++){var r=this.resources[n];if(r.id==t){e=r;break}}return e},GanttMaster.prototype.changeTaskDates=function(t,e,n){return t.setPeriod(e,n)},GanttMaster.prototype.moveTask=function(t,e){return t.moveTo(e,!0)},GanttMaster.prototype.taskIsChanged=function(){var t=this;this.element.stopTime("gnnttaskIsChanged"),this.element.oneTime(50,"gnnttaskIsChanged",function(){t.editor.redraw(),t.gantt.refreshGantt()})},GanttMaster.prototype.redraw=function(){this.editor.redraw(),this.gantt.refreshGantt()},GanttMaster.prototype.reset=function(){this.tasks=[],this.links=[],this.deletedTaskIds=[],this.__inUndoRedo?this.__inUndoRedo=!1:(this.__undoStack=[],this.__redoStack=[]),delete this.currentTask,this.editor.reset(),this.gantt.reset()},GanttMaster.prototype.showTaskEditor=function(t){var e=this.getTask(t);e.rowElement.find(".edit").click()},GanttMaster.prototype.saveProject=function(){return this.saveGantt(!1)},GanttMaster.prototype.saveGantt=function(t){for(var e=[],n=0;n<this.tasks.length;n++){var r=this.tasks[n],s=r.clone();delete s.master,delete s.rowElement,delete s.ganttElement,e.push(s)}var a={tasks:e};return this.currentTask&&(a.selectedRow=this.currentTask.getRow()),a.deletedTaskIds=this.deletedTaskIds,t||(a.resources=this.resources,a.roles=this.roles,a.canWrite=this.canWrite,a.canWriteOnParent=this.canWriteOnParent,a.splitterPosition=this.splitter.perc,a.zoom=this.gantt.zoom),a},GanttMaster.prototype.updateLinks=function(t){function e(t,n,r){if(n==t)return!0;for(var s=t.getSuperiors(),a=t.getParent();a;)s=s.concat(a.getSuperiors()),a=a.getParent();for(var i=t.getChildren(),o=0;o<i.length;o++)s=s.concat(i[o].getSuperiors());for(var c=!1,o=0;o<s.length;o++){var d=s[o];if(d.from==n){c=!0;break}if(r.indexOf(d.from.id+"x"+n.id)<=0&&(r.push(d.from.id+"x"+n.id),e(d.from,n,r))){c=!0;break}}var T=n.getParent();return T&&r.indexOf(t.id+"x"+T.id)<=0&&(r.push(t.id+"x"+T.id),e(t,T,r)&&(c=!0)),c}this.links=this.links.filter(function(e){return e.to!=t});var n=!0;if(t.depends){for(var r=t.getParents(),s=t.getDescendant(),a=t.depends.split(","),i="",o=[],c=0;c<a.length;c++){var d=a[c],T=d.split(":"),u=0;T.length>1&&(u=parseInt(T[1]));var h=this.tasks[parseInt(T[0]-1)];h&&(r&&r.indexOf(h)>=0?(this.setErrorOnTransaction(t.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_ANCESTORS+"\n"+h.name),n=!1):s&&s.indexOf(h)>=0?(this.setErrorOnTransaction(t.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_DESCENDANTS+"\n"+h.name),n=!1):e(h,t,o)?(n=!1,this.setErrorOnTransaction(GanttMaster.messages.CIRCULAR_REFERENCE+"\n"+t.name+" -> "+h.name)):(this.links.push(new Link(h,t,u)),i=i+(i.length>0?",":"")+d))}t.depends=i}return n},GanttMaster.prototype.moveUpCurrentTask=function(){var t=this;t.canWrite&&t.currentTask&&(t.beginTransaction(),t.currentTask.moveUp(),t.endTransaction())},GanttMaster.prototype.moveDownCurrentTask=function(){var t=this;t.canWrite&&t.currentTask&&(t.beginTransaction(),t.currentTask.moveDown(),t.endTransaction())},GanttMaster.prototype.outdentCurrentTask=function(){var t=this;if(t.canWrite&&t.currentTask.canWrite&&t.currentTask){var e=t.currentTask.getParent();t.beginTransaction(),t.currentTask.outdent(),t.endTransaction(),e&&t.editor.refreshExpandStatus(e)}},GanttMaster.prototype.indentCurrentTask=function(){var t=this;t.canWrite&&t.currentTask.canWrite&&t.currentTask&&(t.beginTransaction(),t.currentTask.indent(),t.endTransaction())},GanttMaster.prototype.addBelowCurrentTask=function(){var t=this;if(t.canWrite){var e=new TaskFactory;t.beginTransaction();var n,r=0;t.currentTask?(n=e.build("tmp_"+(new Date).getTime(),"","",t.currentTask.level+1,t.currentTask.start,1),r=t.currentTask.getRow()+1):n=e.build("tmp_"+(new Date).getTime(),"","",0,(new Date).getTime(),1);var s=t.addTask(n,r);s&&(s.rowElement.click(),s.rowElement.find("[name=name]").focus()),t.endTransaction()}},GanttMaster.prototype.addAboveCurrentTask=function(){var t=this;if(t.canWrite){var e,n=new TaskFactory,r=0;if(t.currentTask){if(t.currentTask.level<=0)return;e=n.build("tmp_"+(new Date).getTime(),"","",t.currentTask.level,t.currentTask.start,1),r=t.currentTask.getRow()}else e=n.build("tmp_"+(new Date).getTime(),"","",0,(new Date).getTime(),1);t.beginTransaction();var s=t.addTask(e,r);s&&(s.rowElement.click(),s.rowElement.find("[name=name]").focus()),t.endTransaction()}},GanttMaster.prototype.deleteCurrentTask=function(){var t=this;if(t.currentTask&&t.canWrite&&t.currentTask.canWrite){var e=t.currentTask.getRow();if(t.currentTask&&(e>0||t.currentTask.isNew())){var n=t.currentTask.getParent();t.beginTransaction(),t.currentTask.deleteTask(),t.currentTask=void 0,t.updateDependsStrings(),t.redraw(),n&&t.editor.refreshExpandStatus(n),e=e>t.tasks.length-1?t.tasks.length-1:e,e>=0&&(t.currentTask=t.tasks[e],t.currentTask.rowElement.click(),t.currentTask.rowElement.find("[name=name]").focus()),t.endTransaction()}}},GanttMaster.prototype.beginTransaction=function(){return this.__currentTransaction?console.error("Cannot open twice a transaction"):this.__currentTransaction={snapshot:JSON.stringify(this.saveGantt(!0)),errors:[]},this.__currentTransaction},GanttMaster.prototype.endTransaction=function(){if(!this.__currentTransaction)return console.error("Transaction never started."),!0;var t=!0;if(this.__currentTransaction.errors.length<=0){this.__undoStack.push(this.__currentTransaction.snapshot),this.__redoStack=[],this.gantt.originalStartMillis=1/0,this.gantt.originalEndMillis=-(1/0);for(var e=0;e<this.tasks.length;e++){var n=this.tasks[e];this.gantt.originalStartMillis>n.start&&(this.gantt.originalStartMillis=n.start),this.gantt.originalEndMillis<n.end&&(this.gantt.originalEndMillis=n.end)}this.taskIsChanged()}else{t=!1;var r=JSON.parse(this.__currentTransaction.snapshot);this.deletedTaskIds=r.deletedTaskIds,this.loadTasks(r.tasks,r.selectedRow),this.redraw();for(var s="",e=0;e<this.__currentTransaction.errors.length;e++){var a=this.__currentTransaction.errors[e];s=s+a.msg+"\n\n"}alert(s)}return this.__currentTransaction=void 0,this.editor.refreshExpandStatus(this.currentTask),t},GanttMaster.prototype.setErrorOnTransaction=function(t,e){this.__currentTransaction?this.__currentTransaction.errors.push({msg:t,task:e}):console.error(t)},GanttMaster.prototype.checkpoint=function(){this.__undoStack=[],this.__redoStack=[]},GanttMaster.prototype.undo=function(){if(this.__undoStack.length>0){var t=this.__undoStack.pop();this.__redoStack.push(JSON.stringify(this.saveGantt()));var e=JSON.parse(t);this.deletedTaskIds=e.deletedTaskIds,this.__inUndoRedo=!0,this.loadTasks(e.tasks,e.selectedRow),this.redraw()}},GanttMaster.prototype.redo=function(){if(this.__redoStack.length>0){var t=this.__redoStack.pop();this.__undoStack.push(JSON.stringify(this.saveGantt()));var e=JSON.parse(t);this.deletedTaskIds=e.deletedTaskIds,this.__inUndoRedo=!0,this.loadTasks(e.tasks,e.selectedRow),this.redraw()}},GanttMaster.prototype.resize=function(){this.splitter.resize()},GanttMaster.prototype.getCollapsedDescendant=function(){for(var t=this.tasks,e=[],n=0;n<t.length;n++){var r=t[n];e.indexOf(r)>=0||r.collapsed&&(e=e.concat(r.getDescendant()))}return e},GanttMaster.prototype.computeCriticalPath=function(){function t(t,e){for(var n=0;n<e.length;n++)if(t.indexOf(e[n])<0)return!1;return!0}function e(t){for(var e=-1,n=0;n<t.length;n++){var r=t[n];r.criticalCost>e&&(e=r.criticalCost)}for(var n=0;n<t.length;n++){var r=t[n];r.setLatest(e)}}function n(t){for(var e=[],n=0;n<t.length;n++)t[n].depends&&""!=t[n].depends||e.push(t[n]);return e}function r(t){for(var e=0;e<t.length;e++){var n=t[e];n.earlyStart=0,n.earlyFinish=n.duration,s(n)}}function s(t){for(var e=t.earlyFinish,n=t.getInferiorTasks(),r=0;r<n.length;r++){var a=n[r];e>=a.earlyStart&&(a.earlyStart=e,a.earlyFinish=e+a.duration),s(a)}}function a(t){for(var e=0;e<t.length;e++){var n=t[e];n.isCritical=n.earlyStart==n.latestStart}}if(!this.tasks)return!1;for(var i=this.tasks.filter(function(t){return t.getRow()>0&&(!t.isParent()||t.isParent()&&!t.isDependent())}),o=0;o<i.length;o++){var c=i[o];c.earlyStart=-1,c.earlyFinish=-1,c.latestStart=-1,c.latestFinish=-1,c.criticalCost=-1,c.isCritical=!1}for(var d=[],T=i.concat();T.length>0;){for(var u=!1,o=0;o<T.length;o++){var h=T[o],l=h.getInferiorTasks();if(t(d,l)){for(var k=0,_=0;_<l.length;_++){var c=l[_];c.criticalCost>k&&(k=c.criticalCost)}h.criticalCost=k+h.duration,d.push(h),T.splice(o,1),u=!0}}if(!u)return console.error("Cyclic dependency, algorithm stopped!"),!1}e(i);var f=n(i);return r(f),a(i),i};