function TaskFactory(){this.build=function(t,s,e,r,a,i,n){var h=computeStart(a),o=computeEndByDuration(h,i);return new Task(t,s,e,r,h,o,i,n)}}function Task(t,s,e,r,a,i,n,h){this.id=t,this.name=s,this.progress=0,this.description="",this.code=e,this.level=r,this.status="STATUS_UNDEFINED",this.depends="",this.canWrite=!0,this.start=a,this.duration=n,this.end=i,this.startIsMilestone=!1,this.endIsMilestone=!1,this.collapsed=h,this.rowElement,this.ganttElement,this.master,this.assigs=[]}function updateTree(t){var s=t.getParent();if(!s)return!0;var e=s.start,r=s.end;if(s.start>t.start){if(s.startIsMilestone)return t.master.setErrorOnTransaction(GanttMaster.messages.START_IS_MILESTONE+"\n"+s.name,t),!1;if(s.depends)return t.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_CONSTRAINTS+"\n"+s.name,t),!1;e=t.start}if(s.end<t.end){if(s.endIsMilestone)return t.master.setErrorOnTransaction(GanttMaster.messages.END_IS_MILESTONE+"\n"+s.name,t),!1;r=t.end}return e!=s.start||r!=s.end?s.canWrite?s.hasExternalDep?(t.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS+"\n"+s.name,t),!1):s.setPeriod(e,r):(t.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+s.name,t),!1):!0}function Link(t,s,e){this.from=t,this.to=s,this.lag=e}function Assignment(t,s,e,r){this.id=t,this.resourceId=s,this.roleId=e,this.effort=r}function Resource(t,s){this.id=t,this.name=s}function Role(t,s){this.id=t,this.name=s}Task.prototype.clone=function(){var t={};for(var s in this)"function"!=typeof this[s]&&(t[s]=this[s]);return t},Task.prototype.getAssigsString=function(){for(var t="",s=0;s<this.assigs.length;s++){var e=this.assigs[s],r=this.master.getResource(e.resourceId);r&&(t=t+(""==t?"":", ")+r.name)}return t},Task.prototype.createAssignment=function(t,s,e,r){var a=new Assignment(t,s,e,r);return this.assigs.push(a),a},Task.prototype.setPeriod=function(t,s){t instanceof Date&&(t=t.getTime()),s instanceof Date&&(s=s.getTime());var e={start:this.start,end:this.end,duration:this.duration},r=t;t>s&&(t=s),t=computeStart(t);var a=this.getSuperiors();if(a&&a.length>0){for(var i=0,n=0;n<a.length;n++){var h=a[n];i=Math.max(i,incrementDateByWorkingDays(h.from.end,h.lag))}if(computeStart(i)!=t)return this.moveTo(i+1,!1)}var o=!1;new Date(t);(this.start!=t||this.start!=r)&&(this.start=t,o=!0);var l=s;if(s=computeEnd(s),(this.end!=s||this.end!=l)&&(this.end=s,o=!0),this.duration=recomputeDuration(this.start,this.end),!o)return!0;if(!this.canWrite)return this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+this.name,this),!1;if(this.hasExternalDep)return this.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS+"\n"+this.name,this),!1;var f=!0,m=e.duration-this.duration,u=m>0,T=(u&&e.start<this.start,u&&e.end>this.end);if(u){for(var v=this.getChildren(),g=1/0,d=0,n=0;n<v.length;n++)ch=v[n],T?d=Math.max(d,ch.end):g=Math.min(g,ch.start);T?this.end=Math.max(d,this.end):this.start=Math.min(g,this.start),this.duration=recomputeDuration(this.start,this.end)}else(this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate)&&(this.master.setErrorOnTransaction(GanttMaster.messages.CHANGE_OUT_OF_SCOPE,this),f=!1),f&&!updateTree(this)&&(f=!1);if(f){var c=this.getInferiors();if(c&&c.length>0)for(var n=0;n<c.length;n++){var h=c[n];if(!h.to.canWrite){this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+h.to.name,h.to);break}if(f=h.to.moveTo(s,!1),!f)break}}return f},Task.prototype.moveTo=function(t,s){t instanceof Date&&(t=t.getTime());var e={start:this.start,end:this.end},r=t;if(t=computeStart(t),!s&&this.startIsMilestone&&t!=this.start)return this.master.setErrorOnTransaction(GanttMaster.messages.START_IS_MILESTONE,this),!1;if(this.hasExternalDep)return this.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS,this),!1;var a=this.getSuperiors();if(a&&a.length>0){for(var i=0,n=0;n<a.length;n++){var h=a[n];i=Math.max(i,incrementDateByWorkingDays(h.from.end,h.lag))}t=i+1}t=computeStart(t);var o=computeEndByDuration(t,this.duration);if(this.start!=t||this.start!=r){if(!s&&this.endIsMilestone&&(o=this.end,this.duration=recomputeDuration(t,o)),this.start=t,this.end=o,this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate)return this.master.setErrorOnTransaction(GanttMaster.messages.CHANGE_OUT_OF_SCOPE,this),!1;for(var l=e.start-this.start,f=this.getChildren(),n=0;n<f.length;n++)if(ch=f[n],!ch.moveTo(ch.start-l,!1))return!1;if(!updateTree(this))return!1;var m=this.getInferiors();if(m&&m.length>0)for(var n=0;n<m.length;n++){var h=m[n];if(h.to.canWrite){if(!h.to.moveTo(o,!1))return!1}else this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+h.to.name,h.to)}}return!0},Task.prototype.changeStatus=function(t){function s(t,a,i,n,h){var o=t.status;if(a==o)return!0;var l=!0;if(t.status=a,t.master.cannotCloseTaskIfIssueOpen&&"STATUS_DONE"==a&&t.openIssues>0)return t.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_CLOSE_TASK_IF_OPEN_ISSUE+" "+t.name),!1;if("STATUS_DONE"==a)if(i||"STATUS_FAILED"!=o){for(var f=t.getSuperiors(),m=0;m<f.length;m++)if(r.indexOf(f[m].from)<0&&"STATUS_DONE"!=f[m].from.status){(i||n)&&t.master.setErrorOnTransaction(GanttMaster.messages.GANTT_ERROR_DEPENDS_ON_OPEN_TASK+"\n"+f[m].from.name+" -> "+t.name),l=!1;break}if(l){for(var u=t.getChildren(),m=0;m<u.length;m++)s(u[m],"STATUS_DONE",!1,!0,!1);e(r,t.getInferiors(),"STATUS_ACTIVE")}}else l=!1;else if("STATUS_ACTIVE"==a)if(i||"STATUS_FAILED"!=o){var T=t.getParent();if(T&&"STATUS_ACTIVE"!=T.status&&(l=s(T,"STATUS_ACTIVE",!1,!1,!0)),l)for(var f=t.getSuperiors(),m=0;m<f.length;m++)if("STATUS_DONE"!=f[m].from.status){(i||h)&&t.master.setErrorOnTransaction(GanttMaster.messages.GANTT_ERROR_DEPENDS_ON_OPEN_TASK+"\n"+f[m].from.name+" -> "+t.name),l=!1;break}if(l){var u=t.getChildren();if("STATUS_UNDEFINED"==o||"STATUS_SUSPENDED"==o)for(var m=0;m<u.length;m++)"STATUS_DONE"!=u[m].status&&s(u[m],"STATUS_ACTIVE",!1,!0,!1);for(var v=t.getInferiors(),m=0;m<v.length;m++)s(v[m].to,"STATUS_SUSPENDED",!1,!1,!1)}}else l=!1;else if("STATUS_SUSPENDED"==a||"STATUS_UNDEFINED"==a)if(i||"STATUS_FAILED"!=o){var T=t.getParent();T&&"STATUS_ACTIVE"!=T.status&&(l=s(T,a,!1,!1,!0));for(var u=t.getChildren(),m=0;m<u.length;m++)"STATUS_DONE"!=u[m].status&&s(u[m],a,!1,!0,!1);e(r,t.getInferiors(),a)}else l=!1;else if("STATUS_FAILED"==a){for(var u=t.getChildren(),m=0;m<u.length;m++)s(u[m],"STATUS_FAILED",!1,!0,!1);e(r,t.getInferiors(),"STATUS_FAILED")}return l||(t.status=o),l}function e(t,e,r){for(var a=0;a<e.length;a++)t.indexOf(e[a].to)<0&&s(e[a].to,r,!1,!1,!1)}var r=this.getDescendant(),a=!0,i=this.status;return a=s(this,t,!0,!1,!1),a||(this.status=i),a},Task.prototype.synchronizeStatus=function(){var t=this.status;return this.status="",this.changeStatus(t)},Task.prototype.isLocallyBlockedByDependencies=function(){for(var t=this.getSuperiors(),s=!1,e=0;e<t.length;e++)if("STATUS_DONE"!=t[e].from.status){s=!0;break}return s},Task.prototype.getRow=function(){return ret=-1,this.master&&(ret=this.master.tasks.indexOf(this)),ret},Task.prototype.getParents=function(){var t;if(this.master){var s=this.level,e=this.getRow();t=[];for(var r=e;r>=0;r--){var a=this.master.tasks[r];s>a.level&&(s=a.level,t.push(a))}}return t},Task.prototype.getParent=function(){var t;if(this.master)for(var s=this.getRow();s>=0;s--){var e=this.master.tasks[s];if(this.level>e.level){t=e;break}}return t},Task.prototype.isParent=function(){var t=!1;if(this.master){var s=this.getRow();s<this.master.tasks.length-1&&(t=this.master.tasks[s+1].level>this.level)}return t},Task.prototype.getChildren=function(){var t=[];if(this.master)for(var s=this.getRow(),e=s+1;e<this.master.tasks.length;e++){var r=this.master.tasks[e];if(r.level==this.level+1)t.push(r);else if(r.level<=this.level)break}return t},Task.prototype.getDescendant=function(){var t=[];if(this.master)for(var s=this.getRow(),e=s+1;e<this.master.tasks.length;e++){var r=this.master.tasks[e];if(!(r.level>this.level))break;t.push(r)}return t},Task.prototype.getSuperiors=function(){var t=[],s=this;return this.master&&(t=this.master.links.filter(function(t){return t.to==s})),t},Task.prototype.getSuperiorTasks=function(){for(var t=[],s=this.getSuperiors(),e=0;e<s.length;e++)t.push(s[e].from);return t},Task.prototype.getInferiors=function(){var t=[],s=this;return this.master&&(t=this.master.links.filter(function(t){return t.from==s})),t},Task.prototype.getInferiorTasks=function(){for(var t=[],s=this.getInferiors(),e=0;e<s.length;e++)t.push(s[e].to);return t},Task.prototype.deleteTask=function(){this.rowElement&&this.rowElement.remove(),this.ganttElement&&this.ganttElement.remove();for(var t=this.getChildren(),s=0;s<t.length;s++)t[s].isNew()||this.master.deletedTaskIds.push(t[s].id),t[s].deleteTask();this.isNew()||this.master.deletedTaskIds.push(this.id),this.master.tasks.splice(this.getRow(),1);var e=this;this.master.links=this.master.links.filter(function(t){return t.from!=e&&t.to!=e})},Task.prototype.isNew=function(){return 0==(this.id+"").indexOf("tmp_")},Task.prototype.isDependent=function(t){for(var s=this,e=this.master.links.filter(function(t){return t.from==s}),r=0;r<e.length;r++)if(e[r].to==t)return!0;for(var r=0;r<e.length;r++)if(e[r].to.isDependent(t))return!0;return!1},Task.prototype.setLatest=function(t){this.latestStart=t-this.criticalCost,this.latestFinish=this.latestStart+this.duration},Task.prototype.indent=function(){var t=this.getRow();if(0>=t)return!1;var s=!1,e=this.master.tasks[t-1],r=this.level+1;if(r<=e.level+1){s=!0,this.level++;var a=this.getParents();this.level--;for(var i=this.level,n=t;n<this.master.tasks.length;n++){var h=this.master.tasks[n];if(!(h.level>i||h==this))break;h.level++,this.master.links=this.master.links.filter(function(t){var s=!1;return t.to==h?s=a.indexOf(t.from)>=0:t.from==h&&(s=a.indexOf(t.to)>=0),!s})}var o=this.getParent();if(o&&!this.depends){var l=computeEndByDuration(o.start,this.duration);this.master.changeTaskDates(this,o.start,l)}this.master.updateDependsStrings(),this.setPeriod(this.start+1,this.end+1),this.synchronizeStatus()}return s},Task.prototype.outdent=function(){if(this.level<=1)return!1;var t=!1,s=this.level;t=!0;for(var e=this.getRow(),r=e;r<this.master.tasks.length;r++){var a=this.master.tasks[r];if(!(a.level>s||a==this))break;a.level--}var i=this,n=this.getChildren();this.master.links=this.master.links.filter(function(t){var s=t.to==i&&n.indexOf(t.from)>=0||t.from==i&&n.indexOf(t.to)>=0;return!s});for(var r=0;r<n.length;r++)n[r].setPeriod(n[r].start+1,n[r].end+1);return this.master.updateDependsStrings(),this.setPeriod(this.start+1,this.end+1),this.synchronizeStatus(),t},Task.prototype.moveUp=function(){var t=!1,s=this.getRow();if(0>=s)return!1;var e;for(e=s-1;e>=0&&!(this.master.tasks[e].level<=this.level);e--);if(this.master.tasks[e].level==this.level){t=!0;for(var r=0,a=s+1;a<this.master.tasks.length;a++){var i=this.master.tasks[a];if(!(i.level>this.level))break;r++}var n=this.master.tasks.splice(s,r+1),h=this.master.tasks.splice(0,e);this.master.tasks=[].concat(h,n,this.master.tasks);var o=this.master.editor.element.find("tr[taskid]"),l=o.slice(s,s+r+1);o.eq(e).before(l),this.master.updateDependsStrings()}else this.master.setErrorOnTransaction(GanttMaster.messages.TASK_MOVE_INCONSISTENT_LEVEL,this),t=!1;return t},Task.prototype.moveDown=function(){var t=this.getRow();if(t>=this.master.tasks.length-1||0==t)return!1;var s,e=!1;for(s=t+1;s<this.master.tasks.length&&!(this.master.tasks[s].level<=this.level);s++);if(this.master.tasks[s]&&this.master.tasks[s].level==this.level){for(e=!0,s+=1;s<this.master.tasks.length&&!(this.master.tasks[s].level<=this.level);s++);for(var r=0,a=t+1;a<this.master.tasks.length;a++){var i=this.master.tasks[a];if(!(i.level>this.level))break;r++}var n=this.master.tasks.splice(t,r+1),h=this.master.tasks.splice(0,s-r-1);this.master.tasks=[].concat(h,n,this.master.tasks);var o=this.master.editor.element.find("tr[taskid]"),l=o.eq(s-1),f=o.slice(t,t+r+1);l.after(f),this.master.updateDependsStrings()}return e};