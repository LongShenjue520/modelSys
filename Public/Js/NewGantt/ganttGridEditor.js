function GridEditor(e){this.master=e,this.gridified=$.gridify($.JST.createFromTemplate({},"TASKSEDITHEAD")),this.element=this.gridified.find(".gdfTable").eq(1)}GridEditor.prototype.fillEmptyLines=function(){for(var e=new TaskFactory,t=30-this.element.find(".taskEditRow").size(),a=0;t>a;a++){var n=$.JST.createFromTemplate({},"TASKEMPTYROW"),s=this.master;n.click(function(t){var a=$(this);if(s.canWrite&&!(a.prevAll(".emptyRow").size()>0)){s.beginTransaction();var n,i=(new Date).getTime(),r=0;s.tasks[0]&&(i=s.tasks[0].start,r=s.tasks[0].level+1),a.prevAll(".emptyRow").andSelf().each(function(){var t=e.build("tmp_fk"+(new Date).getTime(),"","",r,i,1);s.addTask(t);n=t}),s.endTransaction(),n.rowElement.click(),n.rowElement.find("[name=name]").focus().blur(function(){var e=$(this);""==e.val()&&(n.name="Task "+(n.getRow()+1),e.val(n.name))})}}),this.element.append(n)}},GridEditor.prototype.addTask=function(e,t,a){this.element.find("[taskId="+e.id+"]").remove();var n=$.JST.createFromTemplate(e,"TASKROW");if(e.rowElement=n,this.bindRowEvents(e,n),"number"!=typeof t){var s=this.element.find(".emptyRow:first");s.size()>0?s.replaceWith(n):this.element.append(n)}else{var i=this.element.find("tr.taskEditRow").eq(t);i.size()>0?i.before(n):this.element.append(n)}if(a){e.collapsed&&n.find(".exp-controller").removeClass("exp");var r=this.master.getCollapsedDescendant();r.indexOf(e)>=0&&n.hide()}return n},GridEditor.prototype.refreshExpandStatus=function(e){if(e){var t=e.getChildren();t.length>0&&0==e.rowElement.has(".expcoll").length?e.rowElement.find(".exp-controller").addClass("expcoll exp"):0==t.length&&e.rowElement.has(".expcoll").length>0&&e.rowElement.find(".exp-controller").removeClass("expcoll exp");var a=e.getParent();a&&0==a.rowElement.has(".expcoll").length&&a.rowElement.find(".exp-controller").addClass("expcoll exp")}},GridEditor.prototype.refreshTaskRow=function(e){var t=e.rowElement;t.find(".taskRowIndex").html(e.getRow()+1),t.find(".indentCell").css("padding-left",10*e.level+18),t.find("[name=name]").val(e.name),t.find("[name=code]").val(e.code),t.find("[status]").attr("status",e.status),t.find("[name=duration]").val(e.duration),t.find("[name=start]").val(new Date(e.start).format()).updateOldValue(),t.find("[name=end]").val(new Date(e.end).format()).updateOldValue(),t.find("[name=depends]").val(e.depends),t.find(".taskAssigs").html(e.getAssigsString())},GridEditor.prototype.redraw=function(){for(var e=0;e<this.master.tasks.length;e++)this.refreshTaskRow(this.master.tasks[e])},GridEditor.prototype.reset=function(){this.element.find("[taskid]").remove()},GridEditor.prototype.bindRowEvents=function(e,t){var a=this;this.master.canWrite&&e.canWrite?a.bindRowInputEvents(e,t):t.find("input").attr("readonly",!0),a.bindRowExpandEvents(e,t),t.find(".edit").click(function(){a.openFullEditor(e,t)})},GridEditor.prototype.bindRowExpandEvents=function(e,t){var a=this;t.find(".exp-controller").click(function(){var e=$(this),t=e.closest("[taskid]").attr("taskid"),n=a.master.getTask(t),s=n.getDescendant();e.toggleClass("exp"),n.collapsed=!e.is(".exp");var i=a.master.getCollapsedDescendant();if(e.is(".exp"))for(var r=0;r<s.length;r++){var d=s[r];i.indexOf(d)>=0||d.rowElement.show()}else for(var r=0;r<s.length;r++)s[r].rowElement.hide();a.master.gantt.refreshGantt()})},GridEditor.prototype.bindRowInputEvents=function(e,t){var a=this;t.find(".date").each(function(){var t=$(this);e.depends&&"start"==t.attr("name")?t.attr("readonly","true"):t.removeAttr("readonly"),t.click(function(){var e=$(this);e.dateField({inputField:t})}),t.blur(function(e){var t=$(this);if(t.isValueChanged())if(Date.isValid(t.val())){var e=Date.parseString(t.val()),n=t.closest("tr"),s=n.attr("taskId"),i=a.master.getTask(s),r=i.start,d=i.end;if("start"==t.attr("name")){if(r=e.getTime(),r>=d){var o=new Date(r);d=o.add("d",i.duration).getTime()}a.master.beginTransaction(),a.master.moveTask(i,r),a.master.endTransaction()}else d=e.getTime(),r>=d&&(d=r),d+=72e6,a.master.beginTransaction(),a.master.changeTaskDates(i,r,d),a.master.endTransaction();t.updateOldValue()}else alert(GanttMaster.messages.INVALID_DATE_FORMAT),t.val(t.getOldValue())})}),t.find("input:not(.date)").focus(function(){$(this).updateOldValue()}).blur(function(){var e=$(this);if(e.isValueChanged()){var t=e.closest("tr"),n=t.attr("taskId"),s=a.master.getTask(n),i=e.attr("name");if(a.master.beginTransaction(),"depends"==i){s.depends;s.depends=e.val(),s.depends?t.find("[name=start]").attr("readonly","true"):t.find("[name=start]").removeAttr("readonly");var r=a.master.updateLinks(s);if(r){for(var d=s.getSuperiors(),o=0;o<d.length&&d[o].from.synchronizeStatus();o++);a.master.changeTaskDates(s,s.start,s.end)}}else if("duration"==i){var l=s.duration;l=parseInt(e.val())||1,e.val(l);var c=computeEndByDuration(s.start,l);a.master.changeTaskDates(s,s.start,c)}else"name"==i&&""==e.val()?s.deleteTask():s[i]=e.val();a.master.endTransaction()}}),t.find("input").keydown(function(e){var t=$(this),a=t.parent(),n=a.parent(),s=a.prevAll("td").size(),i=!0;switch(e.keyCode){case 37:0==this.selectionEnd&&a.prev().find("input").focus();break;case 39:this.selectionEnd==this.value.length&&a.next().find("input").focus();break;case 38:var r=n.prev(),d=r.find("td").eq(s),o=d.find("input");o.size()>0&&o.focus();break;case 40:var l=n.next(),d=l.find("td").eq(s),o=d.find("input");o.size()>0?o.focus():l.click();break;case 36:break;case 35:break;case 9:case 13:}return i}).focus(function(){$(this).closest("tr").click()}),t.find(".taskStatus").click(function(){var e=$(this),t=e.closest("[taskid]"),n=t.attr("taskid"),s=a.master.getTask(n),i=$.JST.createFromTemplate({},"CHANGE_STATUS");i.find("[status="+s.status+"]").addClass("selected"),i.find(".taskStatus").click(function(t){t.stopPropagation();var n=$(this).attr("status");i.remove(),a.master.beginTransaction(),s.changeStatus(n),a.master.endTransaction(),e.attr("status",s.status)}),e.oneTime(3e3,"hideChanger",function(){i.remove()}),e.after(i)}),t.click(function(){var e=$(this);e.closest("table").find(".rowSelected").removeClass("rowSelected"),e.addClass("rowSelected"),a.master.currentTask=a.master.getTask(e.attr("taskId")),a.master.gantt.synchHighlight();var t=e.position().top;t>a.element.parent().height()?e.offsetParent().scrollTop(t-a.element.parent().height()+100):40>t&&e.offsetParent().scrollTop(e.offsetParent().scrollTop()-40+t)})},GridEditor.prototype.openFullEditor=function(e,t){function a(e){var t=parseInt(r.find("#duration").val());e.clearTime(),r.find("#end").val(new Date(computeEndByDuration(e.getTime(),t)).format())}function n(e){var t=Date.parseString(r.find("#start").val());if(e.setHours(23,59,59,999),e.getTime()<t.getTime()){var a=parseInt(r.find("#duration").val());t=incrementDateByWorkingDays(e.getTime(),-a),r.find("#start").val(new Date(computeStart(t)).format())}else r.find("#duration").val(recomputeDuration(t.getTime(),e.getTime()))}var s=this,i=t.attr("taskId"),r=$.JST.createFromTemplate({},"TASK_EDITOR");r.find("#name").val(e.name),r.find("#description").val(e.description),r.find("#code").val(e.code),r.find("#progress").val(e.progress?parseFloat(e.progress):0),r.find("#status").attr("status",e.status),e.startIsMilestone&&r.find("#startIsMilestone").attr("checked",!0),e.endIsMilestone&&r.find("#endIsMilestone").attr("checked",!0),r.find("#duration").val(e.duration);var d=r.find("#start");d.val(new Date(e.start).format()),e.depends?d.attr("readonly","true"):d.removeAttr("readonly"),r.find("#end").val(new Date(e.end).format());var o=r.find("#assigsTable");o.find("[assigId]").remove();for(var l=0;l<e.assigs.length;l++){var c=e.assigs[l],f=$.JST.createFromTemplate({task:e,assig:c},"ASSIGNMENT_ROW");o.append(f)}s.master.canWrite&&e.canWrite?(r.find("#start").click(function(){$(this).dateField({inputField:$(this),callback:a})}).blur(function(){var e=$(this);Date.isValid(e.val())?a(Date.parseString(e.val())):(alert(GanttMaster.messages.INVALID_DATE_FORMAT),e.val(e.getOldValue()))}),r.find("#end").click(function(){$(this).dateField({inputField:$(this),callback:n})}).blur(function(){var e=$(this);Date.isValid(e.val())?n(Date.parseString(e.val())):(alert(GanttMaster.messages.INVALID_DATE_FORMAT),e.val(e.getOldValue()))}),r.find("#duration").change(function(){var e=Date.parseString(r.find("#start").val()),t=$(this),a=parseInt(t.val());a=0>=a?1:a,t.val(a),r.find("#end").val(new Date(computeEndByDuration(e.getTime(),a)).format())}),r.find("#addAssig").click(function(){var t=r.find("#assigsTable"),a=$.JST.createFromTemplate({task:e,assig:{id:"tmp_"+(new Date).getTime()}},"ASSIGNMENT_ROW");t.append(a),$("#bwinPopupd").scrollTop(1e4)}),r.find("#status").click(function(){var t=$(this),a=$.JST.createFromTemplate({},"CHANGE_STATUS");a.find("[status="+e.status+"]").addClass("selected"),a.find(".taskStatus").click(function(e){e.stopPropagation(),t.attr("status",$(this).attr("status")),a.remove()}),t.oneTime(3e3,"hideChanger",function(){a.remove()}),t.after(a)}),r.find("#saveButton").click(function(){var e=s.master.getTask(i);s.master.beginTransaction(),e.name=r.find("#name").val(),e.description=r.find("#description").val(),e.code=r.find("#code").val(),e.progress=parseFloat(r.find("#progress").val()),e.duration=parseInt(r.find("#duration").val()),e.startIsMilestone=r.find("#startIsMilestone").is(":checked"),e.endIsMilestone=r.find("#endIsMilestone").is(":checked"),r.find("tr[assigId]").each(function(){for(var t=$(this),a=t.attr("assigId"),n=t.find("[name=resourceId]").val(),s=t.find("[name=roleId]").val(),i=millisFromString(t.find("[name=effort]").val()),r=!1,d=0;d<e.assigs.length;d++){var o=e.assigs[d];if(a==o.id){o.effort=i,o.roleId=s,o.resourceId=n,o.touched=!0,r=!0;break}if(s==o.roleId&&n==o.resourceId){o.effort=i,o.touched=!0,r=!0;break}}if(!r){var o=e.createAssignment("tmp_"+(new Date).getTime(),n,s,i);o.touched=!0}}),e.assigs=e.assigs.filter(function(e){var t=e.touched;return delete e.touched,t}),e.setPeriod(Date.parseString(r.find("#start").val()).getTime(),Date.parseString(r.find("#end").val()).getTime()+864e5),e.changeStatus(r.find("#status").attr("status")),s.master.endTransaction()&&$("#__blackpopup__").trigger("close")})):(r.find("input,textarea").attr("readOnly",!0),r.find("input:checkbox,select").attr("disabled",!0),r.find("#saveButton").remove());createBlackPage(800,500).append(r)};