function Ganttalendar(t,e,a,s,r){this.master=s,this.element,this.highlightBar,this.svg,this.tasksGroup,this.linksGroup,this.zoom=t,this.minGanttSize=r,this.includeToday=!0,this.showCriticalPath=!1,this.zoomLevels=["d","w","m","q","s","y"],this.element=this.create(t,e,a),this.linkOnProgress=!1,this.rowHeight=30,this.taskHeight=20,this.taskVertOffset=(this.rowHeight-this.taskHeight)/2}Ganttalendar.prototype.zoomGantt=function(t){var e=this.zoom,a=this.zoomLevels.indexOf(e+""),s=a;s=t?0>=a?0:a-1:a>=this.zoomLevels.length-1?this.zoomLevels.length-1:a+1,s!=a&&(e=this.zoomLevels[s],this.zoom=e,this.refreshGantt())},Ganttalendar.prototype.create=function(t,e,a){function s(t,e,a){var s=new Date(e),r=new Date(a);return"d"==t?(s.setHours(0,0,0,0),r.setHours(23,59,59,999),s.setFirstDayOfThisWeek(),r.setFirstDayOfThisWeek(),r.setDate(r.getDate()+6)):"w"==t?(s.setHours(0,0,0,0),r.setHours(23,59,59,999),s.setFirstDayOfThisWeek(),r.setFirstDayOfThisWeek(),r.setDate(r.getDate()+6)):"m"==t?(s.setHours(0,0,0,0),r.setHours(23,59,59,999),s.setDate(1),r.setDate(1),r.setMonth(r.getMonth()+1),r.setDate(r.getDate()-1)):"q"==t?(s.setHours(0,0,0,0),r.setHours(23,59,59,999),s.setDate(1),s.setMonth(3*Math.floor(s.getMonth()/3)),r.setDate(1),r.setMonth(3*Math.floor(r.getMonth()/3)+3),r.setDate(r.getDate()-1)):"s"==t?(s.setHours(0,0,0,0),r.setHours(23,59,59,999),s.setDate(1),s.setMonth(6*Math.floor(s.getMonth()/6)),r.setDate(1),r.setMonth(6*Math.floor(r.getMonth()/6)+6),r.setDate(r.getDate()-1)):"y"==t&&(s.setHours(0,0,0,0),r.setHours(23,59,59,999),s.setDate(1),s.setMonth(0),r.setDate(1),r.setMonth(12),r.setDate(r.getDate()-1)),{start:s.getTime(),end:r.getTime()}}function r(t,e,a,s){var r=$("<th>").html(t).attr("colSpan",e);return s&&r.width(s),a&&r.addClass(a),r}function n(t,e,a){var s=$("<td>").html("").attr("colSpan",t).addClass("ganttBodyCell");return e&&s.addClass("end"),a&&s.addClass(a),s}function i(t,e,a){function s(t,s){for(var r=new Date(e);r.getTime()<=a;)t(r);for(r=new Date(e);r.getTime()<=a;)s(r)}var i,l=$("<tr>").addClass("ganttHead1"),d=$("<tr>").addClass("ganttHead2"),h=$("<tr>").addClass("ganttBody");"y"==t?(i=Math.floor((a-e)/15552e6*100),s(function(t){l.append(r(t.format("yyyy"),2)),t.setFullYear(t.getFullYear()+1)},function(t){var e=Math.floor(t.getMonth()/6)+1;d.append(r(GanttMaster.messages.GANTT_SEMESTER_SHORT+e,1,null,100)),h.append(n(1,2==e)),t.setMonth(t.getMonth()+6)})):"s"==t?(i=Math.floor((a-e)/7776e6*100),s(function(t){var e=new Date(t.getTime());e.setMonth(e.getMonth()+6),e.setDate(e.getDate()-1),l.append(r(t.format("MMM")+" - "+e.format("MMM yyyy"),2)),t.setMonth(t.getMonth()+6)},function(t){var e=Math.floor(t.getMonth()/3)+1;d.append(r(GanttMaster.messages.GANTT_QUARTER_SHORT+e,1,null,100)),h.append(n(1,e%2==0)),t.setMonth(t.getMonth()+3)})):"q"==t?(i=Math.floor((a-e)/2592e6*300),s(function(t){var e=new Date(t.getTime());e.setMonth(e.getMonth()+3),e.setDate(e.getDate()-1),l.append(r(t.format("MMM")+" - "+e.format("MMM yyyy"),3)),t.setMonth(t.getMonth()+3)},function(t){var e=t.format("MMM");d.append(r(e,1,null,300)),h.append(n(1,t.getMonth()%3==2)),t.setMonth(t.getMonth()+1)})):"m"==t?(i=Math.floor((a-e)/864e5*25),s(function(t){var e=t.getTime();t.setMonth(t.getMonth()+1);var a=Math.round((t.getTime()-e)/864e5);l.append(r(new Date(e).format("MMMM yyyy"),a))},function(t){d.append(r(t.format("d"),1,isHoliday(t)?"holyH":null,25));var e=new Date(t.getTime());e.setDate(t.getDate()+1),h.append(n(1,1==e.getDate(),isHoliday(t)?"holy":null)),t.setDate(t.getDate()+1)})):"w"==t?(i=Math.floor((a-e)/864e5*40),s(function(t){var e=new Date(t.getTime());e.setDate(e.getDate()+6),l.append(r(t.format("MMM d")+" - "+e.format("MMM d'yy"),7)),t.setDate(t.getDate()+7)},function(t){d.append(r(t.format("EEEE").substr(0,1),1,isHoliday(t)?"holyH":null,40)),h.append(n(1,t.getDay()%7==(o.master.firstDayOfWeek+6)%7,isHoliday(t)?"holy":null)),t.setDate(t.getDate()+1)})):"d"==t?(i=Math.floor((a-e)/864e5*100),s(function(t){var e=new Date(t.getTime());e.setDate(e.getDate()+6),l.append(r(t.format("MMMM d")+" - "+e.format("MMMM d yyyy"),7)),t.setDate(t.getDate()+7)},function(t){d.append(r(t.format("EEE d"),1,isHoliday(t)?"holyH":null,100)),h.append(n(1,t.getDay()%7==(o.master.firstDayOfWeek+6)%7,isHoliday(t)?"holy":null)),t.setDate(t.getDate()+1)})):console.error("Wrong level "+t),i=Math.max(i,o.minGanttSize);var g=$("<table cellspacing=0 cellpadding=0>");g.append(l).append(d).css({width:i});var c=g.clone().addClass("fixHead");g.append(h).addClass("ganttTable");var f=o.master.editor.element.height();g.height(f);var u=$("<div>");u.addClass("gantt unselectable").attr("unselectable","true").css({position:"relative",width:i}),u.append(g),u.append(c);var p=$("<div>").addClass("ganttHighLight");return u.append(p),o.highlightBar=p,u.svg({settings:{"class":"ganttSVGBox"},onLoad:function(t){var s=t.defs("myDefs"),r=t.pattern(s,"extDep",0,0,10,10,0,0,10,10,{patternUnits:"userSpaceOnUse"});t.image(r,0,0,10,10,o.master.resourceUrl+"hasExternalDeps.png",{opacity:.3});o.svg=t,$(t).addClass("ganttSVGBox");for(var n=t.group("gridGroup"),l=40;f>=l;l+=o.rowHeight)t.line(n,0,l,"100%",l,{"class":"ganttLinesSVG"});if(o.linksGroup=t.group("linksGroup"),o.tasksGroup=t.group("tasksGroup"),o.fx=i/(a-e),(new Date).getTime()>o.startMillis&&(new Date).getTime()<o.endMillis){var d=Math.round(((new Date).getTime()-o.startMillis)*o.fx);t.line(n,d,0,d,"100%",{"class":"ganttTodaySVG"})}}}),u}var o=this;if(this.includeToday){var l=(new Date).getTime();e=e>l?l:e,a=l>a?l:a}var d=s(t,e,a);o.startMillis=d.start,o.endMillis=d.end,o.originalStartMillis=e,o.originalEndMillis=a;var h=i(t,d.start,d.end);return h},Ganttalendar.prototype.drawTask=function(t){function e(t,e){var s=a.svg,r=s.svg(a.tasksGroup,e.x,e.y,e.width,e.height,{"class":"taskBox taskBoxSVG taskStatusSVG",status:t.status,taskid:t.id});s.rect(r,0,0,"100%","100%",{"class":"taskLayout",rx:"2",ry:"2"});if(s.rect(r,0,0,"100%","100%",{fill:"rgba(255,255,255,.3)"}),t.hasExternalDep&&s.rect(r,0,0,"100%","100%",{fill:"url(#extDep)"}),t.progress>0){s.rect(r,0,0,(t.progress>100?100:t.progress)+"%","100%",{rx:"2",ry:"2"});if(e.width>50){var n={fill:"#888","font-size":"10px","class":"textPerc teamworkIcons",transform:"translate(5)"};t.progress>100&&(n["font-weight"]="bold"),t.progress>90&&(n.transform="translate(-40)"),s.text(r,(t.progress>90?100:t.progress)+"%",(a.rowHeight-5)/2,(t.progress>100?"!!! ":"")+t.progress+"%",n)}}return t.hasChild&&s.rect(r,0,0,"100%",3,{fill:"#000"}),t.startIsMilestone&&s.image(r,-9,e.height/2-9,18,18,a.master.resourceUrl+"milestone.png"),t.endIsMilestone&&s.image(r,"100%",e.height/2-9,18,18,a.master.resourceUrl+"milestone.png",{transform:"translate(-9)"}),s.text(r,"100%",18,t.name,{"class":"taskLabelSVG",transform:"translate(20,-5)"}),t.level>0&&(s.circle(r,"0",e.height/2,e.height/3,{"class":"taskLinkStartSVG linkHandleSVG",transform:"translate("+(-e.height/3-1)+")"}),s.circle(r,"100%",e.height/2,e.height/3,{"class":"taskLinkEndSVG linkHandleSVG",transform:"translate("+(e.height/3+1)+")"})),r}var a=this;editorRow=t.rowElement;var s=editorRow.position().top+editorRow.offsetParent().scrollTop(),r=Math.round((t.start-a.startMillis)*a.fx);t.hasChild=t.isParent();var n=$(e(t,{x:r,y:s+a.taskVertOffset,width:Math.round((t.end-t.start)*a.fx),height:a.taskHeight}));t.ganttElement=n,a.showCriticalPath&&t.isCritical&&n.addClass("critical"),this.master.canWrite&&t.canWrite&&(n.click(function(t){t.stopPropagation(),a.element.find(".focused").removeClass("focused"),$(".ganttSVGBox .focused").removeClass("focused");var e=$(this);a.resDrop||e.addClass("focused"),a.resDrop=!1,$("body").off("click.focused").one("click.focused",function(){$(".ganttSVGBox .focused").removeClass("focused")})}).dblclick(function(){a.master.showTaskEditor($(this).attr("taskid"))}).mouseenter(function(){var t=$(this);a.linkOnProgress?t.addClass("linkOver"):t.find(".linkHandleSVG").show()}).mouseleave(function(){var t=$(this);t.removeClass("linkOver").find(".linkHandleSVG").hide()}).mouseup(function(t){$(":focus").blur()}).mousedown(function(){var t=a.master.getTask($(this).attr("taskId"));t.rowElement.click()}).dragExtedSVG($(a.svg.root()),{canResize:this.master.canWrite&&t.canWrite,canDrag:!t.depends&&this.master.canWrite&&t.canWrite,startDrag:function(t){$(".ganttSVGBox .focused").removeClass("focused")},drag:function(e){$("[from="+t.id+"],[to="+t.id+"]").trigger("update")},drop:function(t){a.resDrop=!0;var e=$(this),s=a.master.getTask(e.attr("taskid")),r=Math.round(parseFloat(e.attr("x"))/a.fx+a.startMillis);a.master.beginTransaction(),a.master.moveTask(s,new Date(r)),a.master.endTransaction()},startResize:function(t){$(".ganttSVGBox .focused").removeClass("focused");var e=$(this),s=$(a.svg.text(parseInt(e.attr("x"))+parseInt(e.attr("width")+8),parseInt(e.attr("y")),"",{"font-size":"10px",fill:"red"}));n.data("textDur",s)},resize:function(e){var s=$(this),r=Math.round(parseFloat(s.attr("x"))/a.fx+a.startMillis),i=Math.round((parseFloat(s.attr("x"))+parseFloat(s.attr("width")))/a.fx+a.startMillis),o=computeStartDate(r).distanceInWorkingDays(computeEndDate(i)),l=n.data("textDur");l.attr("x",parseInt(s.attr("x"))+parseInt(s.attr("width"))+8).html(o),$("[from="+t.id+"],[to="+t.id+"]").trigger("update")},stopResize:function(t){a.resDrop=!0;var e=n.data("textDur");e&&e.remove();var s=$(this),r=a.master.getTask(s.attr("taskid")),i=Math.round(parseFloat(s.attr("x"))/a.fx+a.startMillis),o=Math.round((parseFloat(s.attr("x"))+parseFloat(s.attr("width")))/a.fx+a.startMillis);a.master.beginTransaction(),a.master.changeTaskDates(r,new Date(i),new Date(o)),a.master.endTransaction()}}),n.find(".linkHandleSVG").mousedown(function(t){t.preventDefault(),t.stopPropagation();var e=$(this).closest(".taskBoxSVG"),s=$(a.svg.root()),r=s.offset();a.linkOnProgress=!0,a.linkFromEnd=$(this).is(".taskLinkEndSVG"),s.addClass("linkOnProgress");var n=parseFloat(e.attr("x"))+(a.linkFromEnd?parseFloat(e.attr("width")):0),i=parseFloat(e.attr("y"))+parseFloat(e.attr("height"))/2,o=a.svg.line(n,i,t.pageX-r.left-5,t.pageY-r.top-5,{"class":"linkLineSVG"}),l=a.svg.circle(n,i,5,{"class":"linkLineSVG"});s.bind("mousemove.linkSVG",function(t){var e=s.offset(),r=t.pageX-e.left,d=t.pageY-e.top,h=Math.sqrt(Math.pow(r-n,2)+Math.pow(d-i,2));r-=10*(r-n)/h,d-=10*(d-i)/h,a.svg.change(o,{x2:r,y2:d}),a.svg.change(l,{cx:r,cy:d})}),$("body").one("mouseup.linkSVG",function(t){$(o).remove(),$(l).remove(),a.linkOnProgress=!1,s.removeClass("linkOnProgress"),$(a.svg.root()).unbind("mousemove.linkSVG");var r=$(t.target).closest(".taskBoxSVG");if(r&&r.attr("taskid")!=e.attr("taskid")){var n,i;if(a.linkFromEnd?(n=a.master.getTask(r.attr("taskid")),i=a.master.getTask(e.attr("taskid"))):(i=a.master.getTask(r.attr("taskid")),n=a.master.getTask(e.attr("taskid"))),n&&i){var d=0,h=n.rowElement.find("[name=depends]");h.val(h.val()+((h.val()+"").length>0?",":"")+(i.getRow()+1)+(0!=d?":"+d:"")),h.blur()}}})})),a.redrawLinks()},Ganttalendar.prototype.addTask=function(t){this.originalEndMillis=this.originalEndMillis>t.end?this.originalEndMillis:t.end,this.originalStartMillis=this.originalStartMillis<t.start?this.originalStartMillis:t.start},Ganttalendar.prototype.drawLink=function(t,e,a){function s(t){var e=(t.ganttElement.position(),{left:parseFloat(t.ganttElement.attr("x")),top:parseFloat(t.ganttElement.attr("y")),width:parseFloat(t.ganttElement.attr("width")),height:parseFloat(t.ganttElement.attr("height"))});return e}function r(t,e,a){function r(){var t=$(this),e=t.data("from"),r=t.data("to"),i=s(e),o=s(r),l=(i.left,i.left+i.width),d=i.height/2+i.top,h=o.left,g=(o.left+o.width,o.height/2+o.top),c=l+2*a>h,f=5,u=5,p=d>g,m=p?-1:1,v=l+2*a>h,M=v?-1:1,k=t.find("image"),D=n.createPath();if(c){var y=m*(i.height/2-2*f+2);D.move(l,d).line(a,0,!0).arc(f,f,90,!1,!p,f,m*f,!0).line(0,y,!0).arc(f,f,90,!1,!p,-f,m*f,!0).line(2*M*a+(h-l),0,!0).arc(f,f,90,!1,p,-f,m*f,!0).line(0,(Math.abs(g-d)-4*f-Math.abs(y))*m-u,!0).arc(f,f,90,!1,p,f,m*f,!0).line(a,0,!0),k.attr({x:h-5,y:g-5-u})}else D.move(l,d).line((h-l)/2-f,0,!0).arc(f,f,90,!1,!p,f,m*f,!0).line(0,g-d-2*m*f+u,!0).arc(f,f,90,!1,p,f,m*f,!0).line((h-l)/2-f,0,!0),k.attr({x:h-5,y:g-5+u});t.find("path").attr({d:D.path()})}var n=o.svg,i=n.group(o.linksGroup,""+t.id+"-"+e.id);n.title(i,t.name+" -> "+e.name);var l=n.createPath();n.image(i,0,0,5,10,o.master.resourceUrl+"linkArrow.png"),n.path(i,l,{"class":"taskLinkPathSVG"});var d=$(i).data({from:t,to:e}).attr({from:t.id,to:e.id}).on("update",r).trigger("update");return o.showCriticalPath&&t.isCritical&&e.isCritical&&d.addClass("critical"),d.addClass("linkGroup"),d}function n(t,e){console.error("StartToStart not supported on SVG");s(t),s(e)}var i,o=this,l=10;i="start-to-start"==a?n(t,e,l):r(t,e,l),this.master.canWrite&&(t.canWrite||e.canWrite)&&i.click(function(t){var e=$(this);t.stopPropagation(),o.element.find(".focused").removeClass("focused"),$(".ganttSVGBox .focused").removeClass("focused");var e=$(this);o.resDrop||e.addClass("focused"),o.resDrop=!1,$("body").off("click.focused").one("click.focused",function(){$(".ganttSVGBox .focused").removeClass("focused")})})},Ganttalendar.prototype.redrawLinks=function(){var t=this;this.element.stopTime("ganttlnksredr"),this.element.oneTime(60,"ganttlnksredr",function(){$("#linksSVG").empty();for(var e=[],e=t.master.getCollapsedDescendant(),a=0;a<t.master.links.length;a++){var s=t.master.links[a];e.indexOf(s.from)>=0||e.indexOf(s.to)>=0||t.drawLink(s.from,s.to)}})},Ganttalendar.prototype.reset=function(){this.element.find(".linkGroup").remove(),this.element.find("[taskid]").remove()},Ganttalendar.prototype.redrawTasks=function(){for(var t=this.master.getCollapsedDescendant(),e=0;e<this.master.tasks.length;e++){var a=this.master.tasks[e];t.indexOf(a)>=0||this.drawTask(a)}},Ganttalendar.prototype.refreshGantt=function(){this.showCriticalPath&&this.master.computeCriticalPath();var t=this.element.parent(),e=t.scrollTop(),a=t.scrollLeft();if(this.element.remove(),!this.zoom){var s=Math.round((this.originalEndMillis-this.originalStartMillis)/864e5);this.zoom=this.zoomLevels[2>s?0:15>s?1:60>s?2:150>s?3:4]}var r=this.create(this.zoom,this.originalStartMillis,this.originalEndMillis);this.element=r,t.append(r),this.redrawTasks(),t.scrollTop(e),t.scrollLeft(a),this.synchHighlight()},Ganttalendar.prototype.fitGantt=function(){delete this.zoom,this.refreshGantt()},Ganttalendar.prototype.synchHighlight=function(){this.master.currentTask&&this.master.currentTask.ganttElement&&this.highlightBar.css("top",parseInt(this.master.currentTask.ganttElement.attr("y"))-this.taskVertOffset+"px")},Ganttalendar.prototype.centerOnToday=function(){var t=Math.round(((new Date).getTime()-this.startMillis)*this.fx)-30;this.element.parent().scrollLeft(t)},$.fn.dragExtedSVG=function(t,e){function a(e){$(t).unbind("mousemove.deSVG").unbind("mouseup.deSVG").unbind("mouseleave.deSVG"),r&&o.stopResize.call(r.get(0),e),r=void 0,$("body").clearUnselectable()}function s(e){$(t).unbind("mousemove.deSVG").unbind("mouseup.deSVG").unbind("mouseleave.deSVG"),r&&r.attr("oldx")!=r.attr("x")&&o.drop.call(r.get(0),e),r=void 0,$("body").clearUnselectable()}var r,n,i,o={canDrag:!0,canResize:!0,resizeZoneWidth:15,minSize:10,startDrag:function(t){},drag:function(t){},drop:function(t){},startResize:function(t){},resize:function(t){},stopResize:function(t){}};return $.extend(o,e),this.each(function(){var e=$(this);n=t.parent().offset().left,o.canDrag&&e.addClass("deSVGdrag"),(o.canResize||o.canDrag)&&e.bind("mousedown.deSVG",function(n){$(n.target).is("image")&&n.preventDefault(),r=$(this);var l=parseFloat(e.offset().left),d=l+parseFloat(e.attr("width")),h=n.pageX;$("body").unselectable();var g=d-h;if(o.canResize&&g>=0&&g<=o.resizeZoneWidth){i=d-n.pageX,r.attr("oldw",r.attr("width"));var c=!0;$(t).bind("mousemove.deSVG",function(t){c&&(o.startResize.call(r.get(0),t),c=!1);var e=t.pageX,a=e-l+i;r.attr("width",a<o.minSize?o.minSize:a),o.resize.call(r.get(0),t)}),$("body").one("mouseup.deSVG",a)}else if(o.canDrag){i=parseFloat(r.attr("x"))-n.pageX,r.attr("oldx",r.attr("x"));var c=!0;$(t).bind("mousemove.deSVG",function(t){c&&(o.startDrag.call(r.get(0),t),c=!1),r.attr("x",i+t.pageX),o.drag.call(r.get(0),t)}).bind("mouseleave.deSVG",s),$("body").one("mouseup.deSVG",s)}}).bind("mousemove.deSVG",function(t){var e=$(this),a=e.offset().left,s=a+parseFloat(e.attr("width")),r=t.pageX,n=s-r;o.canResize&&n>=0&&n<=o.resizeZoneWidth?e.addClass("deSVGhand"):e.removeClass("deSVGhand")}).addClass("deSVG")}),this};