function Ganttalendar(t,e,a,n,s){this.master=n,this.element,this.highlightBar,this.zoom=t,this.minGanttSize=s,this.includeToday=!0,this.showCriticalPath=!1,this.zoomLevels=["d","w","m","q","s","y"],this.element=this.create(t,e,a)}Ganttalendar.prototype.zoomGantt=function(t){var e=this.zoom,a=this.zoomLevels.indexOf(e+""),n=a;n=t?0>=a?0:a-1:a>=this.zoomLevels.length-1?this.zoomLevels.length-1:a+1,n!=a&&(e=this.zoomLevels[n],this.zoom=e,this.refreshGantt())},Ganttalendar.prototype.create=function(t,e,a){function n(t,e,a){var n=new Date(e),s=new Date(a);return"d"==t?(n.setHours(0,0,0,0),s.setHours(23,59,59,999),n.setFirstDayOfThisWeek(),s.setFirstDayOfThisWeek(),s.setDate(s.getDate()+6)):"w"==t?(n.setHours(0,0,0,0),s.setHours(23,59,59,999),n.setFirstDayOfThisWeek(),s.setFirstDayOfThisWeek(),s.setDate(s.getDate()+6)):"m"==t?(n.setHours(0,0,0,0),s.setHours(23,59,59,999),n.setDate(1),s.setDate(1),s.setMonth(s.getMonth()+1),s.setDate(s.getDate()-1)):"q"==t?(n.setHours(0,0,0,0),s.setHours(23,59,59,999),n.setDate(1),n.setMonth(3*Math.floor(n.getMonth()/3)),s.setDate(1),s.setMonth(3*Math.floor(s.getMonth()/3)+3),s.setDate(s.getDate()-1)):"s"==t?(n.setHours(0,0,0,0),s.setHours(23,59,59,999),n.setDate(1),n.setMonth(6*Math.floor(n.getMonth()/6)),s.setDate(1),s.setMonth(6*Math.floor(s.getMonth()/6)+6),s.setDate(s.getDate()-1)):"y"==t&&(n.setHours(0,0,0,0),s.setHours(23,59,59,999),n.setDate(1),n.setMonth(0),s.setDate(1),s.setMonth(12),s.setDate(s.getDate()-1)),{start:n.getTime(),end:s.getTime()}}function s(t,e,a,n){var s=$("<th>").html(t).attr("colSpan",e);return n&&s.width(n),a&&s.addClass(a),s}function i(t,e,a){var n=$("<td>").html("").attr("colSpan",t).addClass("ganttBodyCell");return e&&n.addClass("end"),a&&n.addClass(a),n}function r(t,e,a){function n(t,n){for(var s=new Date(e);s.getTime()<=a;)t(s);for(s=new Date(e);s.getTime()<=a;)n(s)}var r,l=$("<tr>").addClass("ganttHead1"),d=$("<tr>").addClass("ganttHead2"),h=$("<tr>").addClass("ganttBody");"y"==t?(r=Math.floor((a-e)/15552e6*100),n(function(t){l.append(s(t.format("yyyy"),2)),t.setFullYear(t.getFullYear()+1)},function(t){var e=Math.floor(t.getMonth()/6)+1;d.append(s(GanttMaster.messages.GANTT_SEMESTER_SHORT+e,1,null,100)),h.append(i(1,2==e)),t.setMonth(t.getMonth()+6)})):"s"==t?(r=Math.floor((a-e)/7776e6*100),n(function(t){var e=new Date(t.getTime());e.setMonth(e.getMonth()+6),e.setDate(e.getDate()-1),l.append(s(t.format("MMM")+" - "+e.format("MMM yyyy"),2)),t.setMonth(t.getMonth()+6)},function(t){var e=Math.floor(t.getMonth()/3)+1;d.append(s(GanttMaster.messages.GANTT_QUARTER_SHORT+e,1,null,100)),h.append(i(1,e%2==0)),t.setMonth(t.getMonth()+3)})):"q"==t?(r=Math.floor((a-e)/2592e6*300),n(function(t){var e=new Date(t.getTime());e.setMonth(e.getMonth()+3),e.setDate(e.getDate()-1),l.append(s(t.format("MMM")+" - "+e.format("MMM yyyy"),3)),t.setMonth(t.getMonth()+3)},function(t){var e=t.format("MMM");d.append(s(e,1,null,300)),h.append(i(1,t.getMonth()%3==2)),t.setMonth(t.getMonth()+1)})):"m"==t?(r=Math.floor((a-e)/864e5*25),n(function(t){var e=t.getTime();t.setMonth(t.getMonth()+1);var a=Math.round((t.getTime()-e)/864e5);l.append(s(new Date(e).format("MMMM yyyy"),a))},function(t){d.append(s(t.format("d"),1,isHoliday(t)?"holyH":null,25));var e=new Date(t.getTime());e.setDate(t.getDate()+1),h.append(i(1,1==e.getDate(),isHoliday(t)?"holy":null)),t.setDate(t.getDate()+1)})):"w"==t?(r=Math.floor((a-e)/864e5*40),n(function(t){var e=new Date(t.getTime());e.setDate(e.getDate()+6),l.append(s(t.format("MMM d")+" - "+e.format("MMM d'yy"),7)),t.setDate(t.getDate()+7)},function(t){d.append(s(t.format("EEEE").substr(0,1),1,isHoliday(t)?"holyH":null,40)),h.append(i(1,t.getDay()%7==(o.master.firstDayOfWeek+6)%7,isHoliday(t)?"holy":null)),t.setDate(t.getDate()+1)})):"d"==t?(r=Math.floor((a-e)/864e5*100),n(function(t){var e=new Date(t.getTime());e.setDate(e.getDate()+6),l.append(s(t.format("MMMM d")+" - "+e.format("MMMM d yyyy"),7)),t.setDate(t.getDate()+7)},function(t){d.append(s(t.format("EEE d"),1,isHoliday(t)?"holyH":null,100)),h.append(i(1,t.getDay()%7==(o.master.firstDayOfWeek+6)%7,isHoliday(t)?"holy":null)),t.setDate(t.getDate()+1)})):console.error("Wrong level "+t),r=Math.max(r,o.minGanttSize);var p=$("<table cellspacing=0 cellpadding=0>");p.append(l).append(d).css({width:r});var f=p.clone().addClass("fixHead");p.append(h).addClass("ganttTable"),p.height(o.master.editor.element.height());var g=$("<div>");g.addClass("gantt unselectable").attr("unselectable","true").css({position:"relative",width:r}),g.append(p),g.append(f);var m=$("<div>").addClass("ganttHighLight");g.append(m),o.highlightBar=m;var c=$("<div>");if(c.addClass("ganttLinks").css({position:"absolute",top:0,width:r,height:"100%"}),g.append(c),o.fx=r/(a-e),(new Date).getTime()>o.startMillis&&(new Date).getTime()<o.endMillis){var M=Math.round(((new Date).getTime()-o.startMillis)*o.fx),u=$("<div>").addClass("ganttToday").css("left",M);g.append(u)}return g}var o=this;if(this.includeToday){var l=(new Date).getTime();e=e>l?l:e,a=l>a?l:a}var d=n(t,e,a);o.startMillis=d.start,o.endMillis=d.end,o.originalStartMillis=e,o.originalEndMillis=a;var h=r(t,d.start,d.end);return h},Ganttalendar.prototype.drawTask=function(t){var e=this;editorRow=t.rowElement;var a=editorRow.position().top+editorRow.offsetParent().scrollTop(),n=Math.round((t.start-e.startMillis)*e.fx),s=$.JST.createFromTemplate(t,"TASKBAR");t.ganttElement=s,t.isParent()&&s.addClass("hasChild"),s.css({top:a,left:n,width:Math.round((t.end-t.start)*e.fx)}),this.master.canWrite&&t.canWrite&&s.resizable({handles:"e"+(t.depends?"":",w"),resize:function(t,e){$(".taskLabel[taskId="+e.helper.attr("taskId")+"]").css("width",e.position.left),t.stopImmediatePropagation(),t.stopPropagation()},stop:function(t,a){var n=e.master.getTask(a.element.attr("taskId")),s=Math.round(a.position.left/e.fx+e.startMillis),i=Math.round((a.position.left+a.size.width)/e.fx+e.startMillis);e.master.beginTransaction(),e.master.changeTaskDates(n,new Date(s),new Date(i)),e.master.endTransaction()}}).on("mouseup",function(){$(":focus").blur()}),s.dblclick(function(){e.master.showTaskEditor($(this).closest("[taskId]").attr("taskId"))}).mousedown(function(){var t=e.master.getTask($(this).attr("taskId"));t.rowElement.click()}),!t.depends&&this.master.canWrite&&t.canWrite&&s.css("position","absolute").draggable({axis:"x",drag:function(t,e){$(".taskLabel[taskId="+$(this).attr("taskId")+"]").css("width",e.position.left)},stop:function(t,a){var n=e.master.getTask($(this).attr("taskId")),s=Math.round(a.position.left/e.fx+e.startMillis);e.master.beginTransaction(),e.master.moveTask(n,new Date(s)),e.master.endTransaction()}});var i=$("<div class='ganttLines'></div>");i.css({top:a+i.height()}),e.element.append(s),e.element.append(i),e.redrawLinks()},Ganttalendar.prototype.addTask=function(t){this.originalEndMillis=this.originalEndMillis>t.end?this.originalEndMillis:t.end,this.originalStartMillis=this.originalStartMillis<t.start?this.originalStartMillis:t.start},Ganttalendar.prototype.drawLink=function(t,e,a){function n(t){var e=t.ganttElement.position();return e.width=t.ganttElement.width(),e.height=t.ganttElement.height(),e}function s(a,n,s){var i=$("<div>").attr({from:t.id,to:e.id}),r=a.left+a.width,o=a.height/2+a.top,l=r+2*s<n.left;if(l){var d=(n.left-r)/2,h=new HLine(d,o,r);r+=d,i.append(h);var p,f=n.top+n.height/2-(a.top+a.height/2);p=0>f?new VLine(-f,o+f,r):new VLine(f,o,r),i.append(p),o+=f;var g=new HLine(d,o,r);r+=d,i.append(g)}else{if(s>0){var h=new HLine(s,o,r);r+=s,i.append(h)}var p,m=(n.top+n.height/2-(a.top+a.height/2))/2;p=0>m?new VLine(-m,o+m,r):new VLine(m,o,r),o+=m,i.append(p);var c=a.left+a.width+s-(n.left-s);r-=c;var g=new HLine(c,o,r);i.append(g);var M;if(M=0>m?new VLine(-m,o+m,r):new VLine(m,o,r),i.append(M),o+=m,s>0){var u=new HLine(s,o,r);r+=s,i.append(u)}}var v=$("<img src='res/linkArrow.png'>").css({position:"absolute",top:n.top+n.height/2-5,left:n.left-5});return i.append(v),i}function i(a,n,s){var i=$("<div>").attr({from:t.id,to:e.id}),r=a.left,o=a.height/2+a.top,l=r+2*s<n.left;if(l){var d=new HLine(s,o,r-s);r-=s,i.append(d);var h,p=n.top+n.height/2-(a.top+a.height/2);h=0>p?new VLine(-p,o+p,r):new VLine(p,o,r),i.append(h),o+=p;var f=new HLine(r+s+(n.left-a.left),o,r);r=r+s+(n.left-a.left),i.append(f)}else{if(s>0){var d=new HLine(s,o,r-s);r-=s,i.append(d)}var h,g=(n.top+n.height/2-(a.top+a.height/2))/2;h=0>g?new VLine(-g,o+g,r):new VLine(g,o,r),o+=g,i.append(h);var m=a.left-s-(n.left-s);r-=m;var f=new HLine(m,o,r);i.append(f);var c;if(c=0>g?new VLine(-g,o+g,r):new VLine(g,o,r),i.append(c),o+=g,s>0){var M=new HLine(s,o,r);r+=s,i.append(M)}}var u=$("<img src='res/linkArrow.png'>").css({position:"absolute",top:n.top+n.height/2-5,left:n.left-5});return i.append(u),i}var r=10,o=2;HLine=function(t,e,a){var n=$("<div>").addClass("taskDepLine");return n.css({height:o,left:a,width:t,top:e-o/2}),n},VLine=function(t,e,a){var n=$("<div>").addClass("taskDepLine");return n.css({height:t,left:a-o/2,width:o,top:e}),n};var l=n(t),d=n(e);"start-to-start"==a?this.element.find(".ganttLinks").append(i(l,d,r)):this.element.find(".ganttLinks").append(s(l,d,r))},Ganttalendar.prototype.redrawLinks=function(){var t=this;this.element.stopTime("ganttlnksredr"),this.element.oneTime(60,"ganttlnksredr",function(){t.element.find(".ganttLinks").empty();for(var e=t.master.getCollapsedDescendant(),a=0;a<t.master.links.length;a++){var n=t.master.links[a];e.indexOf(n.from)>=0||e.indexOf(n.to)>=0||t.drawLink(n.from,n.to)}})},Ganttalendar.prototype.reset=function(){this.element.find(".ganttLinks").empty(),this.element.find("[taskid]").remove()},Ganttalendar.prototype.redrawTasks=function(){for(var t=this.master.getCollapsedDescendant(),e=0;e<this.master.tasks.length;e++){var a=this.master.tasks[e];t.indexOf(a)>=0||this.drawTask(a)}},Ganttalendar.prototype.refreshGantt=function(){var t=this.element.parent(),e=t.scrollTop(),a=t.scrollLeft();if(this.element.remove(),!this.zoom){var n=Math.round((this.originalEndMillis-this.originalStartMillis)/864e5);this.zoom=this.zoomLevels[2>n?0:15>n?1:60>n?2:150>n?3:4]}var s=this.create(this.zoom,this.originalStartMillis,this.originalEndMillis);this.element=s,t.append(s),this.redrawTasks(),this.synchHighlight(),t.scrollTop(e),t.scrollLeft(a),this.showCriticalPath&&(this.master.computeCriticalPath(),this.gantt.showCriticalPath())},Ganttalendar.prototype.fitGantt=function(){delete this.zoom,this.refreshGantt()},Ganttalendar.prototype.synchHighlight=function(){this.master.currentTask&&this.master.currentTask.ganttElement&&this.highlightBar.css("top",this.master.currentTask.ganttElement.css("top"))},Ganttalendar.prototype.centerOnToday=function(){var t=Math.round(((new Date).getTime()-this.startMillis)*this.fx)-30;this.element.parent().scrollLeft(t)},Ganttalendar.prototype.showCriticalPath=function(){console.error("To be implemented")};