!function(e){e.fn.dragsort=function(t){var o=e.extend({},e.fn.dragsort.defaults,t),r=[],l=null,a=null;return this.selector&&e("head").append("<style type='text/css'>"+(this.selector.split(",").join(" "+o.dragSelector+",")+" "+o.dragSelector)+" { cursor: pointer; }</style>"),this.each(function(t,i){e(i).is("table")&&1==e(i).children().size()&&e(i).children().is("tbody")&&(i=e(i).children().get(0));var s={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:i,init:function(){e(this.container).attr("data-listIdx",t).mousedown(this.grabItem).find(o.dragSelector).css("cursor","pointer"),e(this.container).children(o.itemSelector).each(function(t){e(this).attr("data-itemIdx",t)})},grabItem:function(t){if(1==t.which&&!e(t.target).is(o.dragSelectorExclude)){for(var a=t.target;!e(a).is("[data-listIdx='"+e(this).attr("data-listIdx")+"'] "+o.dragSelector);){if(a==this)return;a=a.parentNode}null!=l&&null!=l.draggedItem&&l.dropItem(),e(t.target).css("cursor","move"),l=r[e(this).attr("data-listIdx")],l.draggedItem=e(a).closest(o.itemSelector),a=parseInt(l.draggedItem.css("marginTop"));var i=parseInt(l.draggedItem.css("marginLeft"));l.offset=l.draggedItem.offset(),l.offset.top=t.pageY-l.offset.top+(isNaN(a)?0:a)-1,l.offset.left=t.pageX-l.offset.left+(isNaN(i)?0:i)-1,o.dragBetween||(a=0==e(l.container).outerHeight()?Math.max(1,Math.round(.5+e(l.container).children(o.itemSelector).size()*l.draggedItem.outerWidth()/e(l.container).outerWidth()))*l.draggedItem.outerHeight():e(l.container).outerHeight(),l.offsetLimit=e(l.container).offset(),l.offsetLimit.right=l.offsetLimit.left+e(l.container).outerWidth()-l.draggedItem.outerWidth(),l.offsetLimit.bottom=l.offsetLimit.top+a-l.draggedItem.outerHeight()),a=l.draggedItem.height(),i=l.draggedItem.width();var s=l.draggedItem.attr("style");return l.draggedItem.attr("data-origStyle",s?s:""),"tr"==o.itemSelector?(l.draggedItem.children().each(function(){e(this).width(e(this).width())}),l.placeHolderItem=l.draggedItem.clone().attr("data-placeHolder",!0),l.draggedItem.after(l.placeHolderItem),l.placeHolderItem.children().each(function(){e(this).css({borderWidth:0,width:e(this).width()+1,height:e(this).height()+1}).html("&nbsp;")})):(l.draggedItem.after(o.placeHolderTemplate),l.placeHolderItem=l.draggedItem.next().css({height:a,width:i}).attr("data-placeHolder",!0)),l.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:a,width:i}),e(r).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),l.scroll={moveX:0,moveY:0,maxX:e(document).width()-e(window).width(),maxY:e(document).height()-e(window).height()},l.scroll.scrollY=window.setInterval(function(){if(o.scrollContainer!=window)e(o.scrollContainer).scrollTop(e(o.scrollContainer).scrollTop()+l.scroll.moveY);else{var t=e(o.scrollContainer).scrollTop();(l.scroll.moveY>0&&t<l.scroll.maxY||l.scroll.moveY<0&&t>0)&&(e(o.scrollContainer).scrollTop(t+l.scroll.moveY),l.draggedItem.css("top",l.draggedItem.offset().top+l.scroll.moveY+1))}},10),l.scroll.scrollX=window.setInterval(function(){if(o.scrollContainer!=window)e(o.scrollContainer).scrollLeft(e(o.scrollContainer).scrollLeft()+l.scroll.moveX);else{var t=e(o.scrollContainer).scrollLeft();(l.scroll.moveX>0&&t<l.scroll.maxX||l.scroll.moveX<0&&t>0)&&(e(o.scrollContainer).scrollLeft(t+l.scroll.moveX),l.draggedItem.css("left",l.draggedItem.offset().left+l.scroll.moveX+1))}},10),l.setPos(t.pageX,t.pageY),e(document).bind("selectstart",l.stopBubble),e(document).bind("mousemove",l.swapItems),e(document).bind("mouseup",l.dropItem),o.scrollContainer!=window&&e(window).bind("DOMMouseScroll mousewheel",l.wheel),!1}},setPos:function(t,r){var a=r-this.offset.top,i=t-this.offset.left;if(o.dragBetween||(a=Math.min(this.offsetLimit.bottom,Math.max(a,this.offsetLimit.top)),i=Math.min(this.offsetLimit.right,Math.max(i,this.offsetLimit.left))),this.draggedItem.parents().each(function(){if("static"!=e(this).css("position")&&(!e.browser.mozilla||"table"!=e(this).css("display"))){var t=e(this).offset();return a-=t.top,i-=t.left,!1}}),o.scrollContainer==window)r-=e(window).scrollTop(),t-=e(window).scrollLeft(),r=Math.max(0,r-e(window).height()+5)+Math.min(0,r-5),t=Math.max(0,t-e(window).width()+5)+Math.min(0,t-5);else{var s=e(o.scrollContainer),n=s.offset();r=Math.max(0,r-s.height()-n.top)+Math.min(0,r-n.top),t=Math.max(0,t-s.width()-n.left)+Math.min(0,t-n.left)}l.scroll.moveX=0==t?0:t*o.scrollSpeed/Math.abs(t),l.scroll.moveY=0==r?0:r*o.scrollSpeed/Math.abs(r),this.draggedItem.css({top:a,left:i})},wheel:function(t){if((e.browser.safari||e.browser.mozilla)&&l&&o.scrollContainer!=window){var r=e(o.scrollContainer),a=r.offset();t.pageX>a.left&&t.pageX<a.left+r.width()&&t.pageY>a.top&&t.pageY<a.top+r.height()&&(a=t.detail?5*t.detail:t.wheelDelta/-2,r.scrollTop(r.scrollTop()+a),t.preventDefault())}},buildPositionTable:function(){var t=null==this.draggedItem?null:this.draggedItem.get(0),r=[];e(this.container).children(o.itemSelector).each(function(o,l){if(l!=t){var a=e(l).offset();a.right=a.left+e(l).width(),a.bottom=a.top+e(l).height(),a.elm=l,r.push(a)}}),this.pos=r},dropItem:function(){if(null!=l.draggedItem){e(l.container).find(o.dragSelector).css("cursor","pointer"),l.placeHolderItem.before(l.draggedItem),l.draggedItem.attr("style",l.draggedItem.attr("data-origStyle")).removeAttr("data-origStyle"),l.placeHolderItem.remove(),e("[data-dropTarget]").remove(),window.clearInterval(l.scroll.scrollY),window.clearInterval(l.scroll.scrollX);var t=!1;return e(r).each(function(){e(this.container).children(o.itemSelector).each(function(o){parseInt(e(this).attr("data-itemIdx"))!=o&&(t=!0,e(this).attr("data-itemIdx",o))})}),t&&o.dragEnd.apply(l.draggedItem),l.draggedItem=null,e(document).unbind("selectstart",l.stopBubble),e(document).unbind("mousemove",l.swapItems),e(document).unbind("mouseup",l.dropItem),o.scrollContainer!=window&&e(window).unbind("DOMMouseScroll mousewheel",l.wheel),!1}},stopBubble:function(){return!1},swapItems:function(t){if(null==l.draggedItem)return!1;l.setPos(t.pageX,t.pageY);for(var i=l.findPos(t.pageX,t.pageY),s=l,n=0;-1==i&&o.dragBetween&&n<r.length;n++)i=r[n].findPos(t.pageX,t.pageY),s=r[n];return-1==i||e(s.pos[i].elm).attr("data-placeHolder")?!1:(null==a||a.top>l.draggedItem.offset().top||a.left>l.draggedItem.offset().left?e(s.pos[i].elm).before(l.placeHolderItem):e(s.pos[i].elm).after(l.placeHolderItem),e(r).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),a=l.draggedItem.offset(),!1)},findPos:function(e,t){for(var o=0;o<this.pos.length;o++)if(this.pos[o].left<e&&this.pos[o].right>e&&this.pos[o].top<t&&this.pos[o].bottom>t)return o;return-1},createDropTargets:function(){o.dragBetween&&e(r).each(function(){var t=e(this.container).find("[data-placeHolder]"),o=e(this.container).find("[data-dropTarget]");t.size()>0&&o.size()>0?o.remove():0==t.size()&&0==o.size()&&e(this.container).append(l.placeHolderItem.clone().removeAttr("data-placeHolder").attr("data-dropTarget",!0))})}};s.init(),r.push(s)}),this},e.fn.dragsort.defaults={itemSelector:"li",dragSelector:"li",dragSelectorExclude:"input, textarea, a[href]",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"<li>&nbsp;</li>",scrollContainer:window,scrollSpeed:5}}(jQuery);