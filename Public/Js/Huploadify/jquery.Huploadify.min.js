!function(e){e.fn.Huploadify=function(i){var t='<div id="${fileID}" class="uploadify-queue-item"><div class="uploadify-info"><span class="up_filename">${fileName}</span><span class="btn btn-default btn-sm uploadbtn">上传</span><span class="delfilebtn">&times;</span></div><div class="preview-box"></div><div class="uploadify-progress"><div class="uploadify-progress-bar"></div></div></div>',n={fileTypeExts:"",uploader:"",auto:!1,method:"post",multi:!1,formData:{},fileObjName:"file",fileSizeLimit:204800,previewImg:!1,previewLoadimg:null,dragDrop:!1,showUploadedPercent:!0,showUploadedSize:!1,buttonText:"选择文件",removeTimeout:1e3,itemTemplate:t,breakPoints:!1,fileSplitSize:1048576,getUploadedSize:null,saveUploadedSize:null,saveInfoLocal:!1,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onSelect:null},l=e.extend(n,i),o=function(e,i){return e=e>1048576&&!i?(Math.round(100*e/1048576)/100).toString()+"MB":(Math.round(100*e/1024)/100).toString()+"KB"},a=function(e,i){for(var t=0;t<i.length;t++)if(i[t].index==e)return i[t];return!1},d=function(e){var i,t,n=[],l=e.split(";");for(i=0,t=l.length;t>i;i++)n.push(l[i].split(".").pop());return n},p={zip:["application/x-zip-compressed"],jpg:["image/jpeg"],png:["image/png"],gif:["image/gif"],doc:["application/msword"],xls:["application/msexcel"],docx:["application/vnd.openxmlformats-officedocument.wordprocessingml.document"],xlsx:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],ppt:["application/vnd.ms-powerpoint"],pptx:["application/vnd.openxmlformats-officedocument.presentationml.presentation"],mp3:["audio/mp3"],mp4:["video/mp4"],pdf:["application/pdf"]},r=function(e){return p[e]},s=function(e){var i,t,n,l=d(e),o=[];for(i=0,t=l.length;t>i;i++)n=r(l[i]),n&&o.push(n);return o.join(",")},f=function(e,i,t,n){i.open(l.method,e,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest");var o=new FormData;if(o.append(l.fileObjName,t),n)for(key in n)o.append(key,n[key]);i.send(o)},u=null;return this.each(function(){var i,t,n,a=e(this);a.addClass("uploadify"),i=a.attr("id"),t='<input id="'+i+'_selectbtn" class="selectbtn" style="display:none;" type="file" name="fileselect[]"',t+=l.multi?" multiple":"",t+=' accept="',t+=s(l.fileTypeExts),t+='"/>',t+='<a id="'+i+'_fileuploadbtn" href="javascript:void(0)" class="btn btn-default btn-sm Huploadify-button">',t+=l.buttonText,t+="</a>",n='<div id="'+i+'_fileuploadqueue" class="uploadify-queue"></div>',a.append(t+n),u={uploadAllowed:!0,fileInput:a.find(".selectbtn"),uploadFileList:a.find(".uploadify-queue"),url:l.uploader,fileFilter:[],uploadOver:!1,filter:function(i){var t,n,a,p=[],r=d(l.fileTypeExts);if(r.length>0)for(t=0,n=i.length;n>t;t++)a=i[t],parseInt(o(a.size,!0))>l.fileSizeLimit?alert("文件"+a.name+"大小超出限制！"):e.inArray(a.name.split(".").pop().toLowerCase(),r)>=0?p.push(a):alert("文件"+a.name+"类型不允许！");return p},funSelect:function(t){var n,d,p,r,s,f,c,m,v,g,h;for(a.find(".uploadify-queue").show(),n=0,d=t.length;d>n;n++)p=t[n],r=e(l.itemTemplate.replace(/\${fileID}/g,i+"_fileuploadfile_"+p.index).replace(/\${fileName}/g,p.name).replace(/\${fileSize}/g,o(p.size)).replace(/\${instanceID}/g,a.attr("id"))),l.auto&&r.find(".uploadbtn").remove(),s=0,f="0KB",c="0%",l.breakPoints&&(m=this.funGetUploadedSize(p),m>p.size&&(m=p.size),s=100*(m/p.size)+"%",f=o(m),c=(100*(m/p.size)).toFixed(2)+"%",r.find(".uploadify-progress-bar").css("width",s)),this.uploadFileList.append(r),l.previewImg?(v=r.find(".preview-box"),l.previewLoadimg&&v.html('<img src="'+l.previewLoadimg+'" height="114">'),u.previewImg(p,v)):r.find(".preview-box").remove(),l.showUploadedSize&&(g='<span class="progressnum"><span class="uploadedsize">'+f+'</span>/<span class="totalsize">${fileSize}</span></span>'.replace(/\${fileSize}/g,o(p.size)),r.find(".uploadify-progress").after(g)),l.showUploadedPercent&&(h='<span class="up_percent">'+c+"</span>",r.find(".uploadify-progress").after(h)),l.onSelect&&l.onSelect(t),l.auto?this.funUploadFile(p):r.find(".uploadbtn").on("click",function(e){return function(){u.funUploadFile(e)}}(p)),r.find(".delfilebtn").on("click",function(e){return function(){u.funDeleteFile(e.index)}}(p))},onProgress:function(e,t,n){var d,p,r,s,f=a.find("#"+i+"_fileuploadfile_"+e.index+" .uploadify-progress"),u=t,c=f.attr("lastLoaded")||0;t-=parseInt(c),d=f.children(".uploadify-progress-bar"),p=l.breakPoints?parseFloat(d.get(0).style.width||0):0,r=(100*(t/n)+p).toFixed(2),s=r>100?"99.99%":r+"%",l.showUploadedSize&&(f.nextAll(".progressnum .uploadedsize").text(o(t)),f.nextAll(".progressnum .totalsize").text(o(n))),l.showUploadedPercent&&f.nextAll(".up_percent").text(s),d.css("width",s),u<l.fileSplitSize?f.attr("lastLoaded",u):f.removeAttr("lastLoaded")},previewImg:function(e,i){if(e&&i.length){var t=new FileReader;t.onload=function(e){var t='<span class="img-box"><img src="'+e.target.result+'"></span>';i.html(t)},t.readAsDataURL(e)}},funGetProgressWidth:function(e){var t=a.find("#"+i+"_fileuploadfile_"+e+" .uploadify-progress-bar");return t.get(0).style.width||""},funGetUploadedSize:function(e){return l.getUploadedSize?l.getUploadedSize(e):l.saveInfoLocal?parseInt(localStorage.getItem(e.name))||0:void 0},funSaveUploadedSize:function(e,i){l.saveUploadedSize?l.saveUploadedSize(e,i):l.saveInfoLocal&&localStorage.setItem(e.name,i)},funGetFiles:function(e){var i,t,n=e.target.files||e.dataTransfer.files;for(n=this.filter(n),i=0,t=n.length;t>i;i++)this.fileFilter.push(n[i]);return this.funDealFiles(n),this},funDealFiles:function(e){var t,n,l=a.find(".uploadify-queue .uploadify-queue-item").length;for(t=0,n=e.length;n>t;t++)e[t].index=++l,e[t].id=i+"_fileuploadfile_"+e[t].index;return this.funSelect(e),this},funDeleteFile:function(e){var t,n,o;for(t=0,n=this.fileFilter.length;n>t;t++)if(o=this.fileFilter[t],o.index==e){l.breakPoints&&(this.uploadAllowed=!1),this.fileFilter.splice(t,1),a.find("#"+i+"_fileuploadfile_"+e).fadeOut("normal",function(){var e=a.find(".uploadify-queue-item:visible").length;0==e&&a.find(".uploadify-queue").hide()}),u.fileInput.val(""),l.onCancel&&l.onCancel(o);break}return this},funUploadFile:function(e){var t,n,o,d,p,r=!1,s=e,c=a.find("#"+i+"_fileuploadfile_"+e.index),m=function(){u.uploadOver&&(c.find(".uploadify-progress-bar").css("width","100%"),l.showUploadedSize&&c.find(".uploadedsize").text(c.find(".totalsize").text()),l.showUploadedPercent&&c.find(".up_percent").text("100%"))};try{r=new XMLHttpRequest}catch(v){r=ActiveXobject("Msxml12.XMLHTTP")}l.breakPoints&&(t=e.name,n=e.id,o=e.index,d=e.size,p=parseInt(this.funGetUploadedSize(s)),e=s.slice(p,p+l.fileSplitSize),e.name=t,e.id=n,e.index=o),r.upload&&p!==!1&&(r.upload.addEventListener("progress",function(i){u.onProgress(e,i.loaded,s.size)},!1),r.onreadystatechange=function(){4==r.readyState&&(u.uploadOver=!0,200==r.status?(JSON.parse(r.responseText),l.breakPoints?(p+=l.fileSplitSize,u.funSaveUploadedSize(s,p),d>p?(u.uploadOver=!1,u.uploadAllowed&&(e=s.slice(p,p+l.fileSplitSize),e.name=t,e.id=n,e.index=o,e.size=d,f(u.url,r,e,l.formData))):m()):m(),u.uploadOver&&(l.onUploadSuccess&&l.onUploadSuccess.call(a,s,r.responseText),setTimeout(function(){a.find("#"+i+"_fileuploadfile_"+s.index).fadeOut("normal",function(){var e=a.find(".uploadify-queue-item:visible").length;0==e&&a.find(".uploadify-queue").hide()})},l.removeTimeout))):u.uploadOver&&l.onUploadError&&l.onUploadError(s,r.responseText),u.uploadOver&&(l.onUploadComplete&&l.onUploadComplete(s,r.responseText),u.fileInput.val("")))},l.onUploadStart&&l.onUploadStart(),l.formData.fileName=s.name,l.formData.lastModifiedDate=s.lastModifiedDate.getTime(),u.uploadAllowed=!0,f(this.url,r,e,l.formData))},init:function(){this.fileInput.length>0&&this.fileInput.change(function(e){u.funGetFiles(e)}),a.find(".Huploadify-button").on("click",function(){a.find(".selectbtn").trigger("click")}),l.onInit&&l.onInit()}},l.dragDrop&&(a[0].ondragover=function(e){return e.preventDefault(),!0},a[0].ondrop=function(e){e.stopPropagation(),e.preventDefault(),u.funGetFiles(e)}),u.init()}),{stop:function(){u.uploadOver=!1,u.uploadAllowed=!1},upload:function(e){var i,t,n;if("*"===e)for(i=0,t=u.fileFilter.length;t>i;i++)u.funUploadFile(u.fileFilter[i]);else n=a(e,u.fileFilter),n&&u.funUploadFile(n)},cancel:function(e){if("*"===e)for(var i=0,t=u.fileFilter.length;t>i;i++)u.funDeleteFile(++i);else u.funDeleteFile(e)},disable:function(i){var t=e(i?"file_upload_"+i+"-button":"body");t.find(".Huploadify-button").prop("disabled",!0).off("click")},ennable:function(i){var t=e(i?"file_upload_"+i+"-button":"body");t.find(".Huploadify-button").prop("disabled",!1).on("click",function(){t.find(".selectbtn").trigger("click")})}}}}(jQuery);