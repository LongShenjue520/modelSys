var navTab={componentBox:null,_tabBox:null,_prevBut:null,_nextBut:null,_panelBox:null,_moreBut:null,_moreBox:null,_currentIndex:0,_op:{id:"navTab",stTabBox:".navTab-tab",stPanelBox:".navTab-panel",mainTabId:"main",close$:"a.close",prevClass:"tabsLeft",nextClass:"tabsRight",stMore:".tabsMore",stMoreLi:"ul.tabsMoreList"},init:function(t){$.History&&$.History.init("#container");var e=this;$.extend(this._op,t),this.componentBox=$("#"+this._op.id),this._tabBox=this.componentBox.find(this._op.stTabBox),this._panelBox=this.componentBox.find(this._op.stPanelBox),this._prevBut=this.componentBox.find("."+this._op.prevClass),this._nextBut=this.componentBox.find("."+this._op.nextClass),this._moreBut=this.componentBox.find(this._op.stMore),this._moreBox=this.componentBox.find(this._op.stMoreLi),this._prevBut.click(function(t){e._scrollPrev()}),this._nextBut.click(function(t){e._scrollNext()}),this._moreBut.click(function(){return e._moreBox.show(),!1}),$(document).click(function(){e._moreBox.hide()}),this._contextmenu(this._tabBox),this._contextmenu(this._getTabs()),this._init(),this._ctrlScrollBut()},_init:function(){var t=this;this._getTabs().each(function(e){$(this).unbind("click").click(function(a){t._switchTab(e)}),$(this).find(navTab._op.close$).unbind("click").click(function(){t._closeTab(e)})}),this._getMoreLi().each(function(e){$(this).find(">a").unbind("click").click(function(a){t._switchTab(e)})}),this._switchTab(this._currentIndex)},_contextmenu:function(t){var e=this;t.contextMenu("navTabCM",{bindings:{reload:function(t,a){e._reload(t,!0)},closeCurrent:function(t,a){var i=t.attr("tabid");i?e.closeTab(i):e.closeCurrentTab()},closeOther:function(t,a){var i=e._indexTabId(t.attr("tabid"));e._closeOtherTab(i>0?i:e._currentIndex)},closeAll:function(t,a){e.closeAllTab()}},ctrSub:function(t,a){var i=a.find("[rel='reload']"),s=a.find("[rel='closeCurrent']"),n=a.find("[rel='closeOther']"),r=a.find("[rel='closeAll']"),l=e._getTabs();l.size()<2&&(s.addClass("disabled"),n.addClass("disabled"),r.addClass("disabled")),0==e._currentIndex||t.attr("tabid")==e._op.mainTabId?(s.addClass("disabled"),i.addClass("disabled")):2==l.size()&&n.addClass("disabled")}})},_getTabs:function(){return this._tabBox.find("> li")},_getPanels:function(){return this._panelBox.find("> div")},_getMoreLi:function(){return this._moreBox.find("> li")},_getTab:function(t){var e=this._indexTabId(t);return e>=0?this._getTabs().eq(e):void 0},_getPanel:function(t){var e=this._indexTabId(t);return e>=0?this._getPanels().eq(e):void 0},_getTabsW:function(t,e){return this._tabsW(this._getTabs().slice(t,e))},_tabsW:function(t){var e=0;return t.each(function(){e+=$(this).outerWidth(!0)}),e},_indexTabId:function(t){if(!t)return-1;var e=-1;return this._getTabs().each(function(a){return $(this).attr("tabid")==t?void(e=a):void 0}),e},_getLeft:function(){return this._tabBox.position().left},_getScrollBarW:function(){return this.componentBox.width()-55},_visibleStart:function(){for(var t=this._getLeft(),e=0,a=this._getTabs(),i=0;i<a.size();i++){if(e+t>=0)return i;e+=a.eq(i).outerWidth(!0)}return 0},_visibleEnd:function(){for(var t=this._getLeft(),e=0,a=this._getTabs(),i=0;i<a.size();i++)if(e+=a.eq(i).outerWidth(!0),e+t>this._getScrollBarW())return i;return a.size()},_scrollPrev:function(){var t=this._visibleStart();t>0&&this._scrollTab(-this._getTabsW(0,t-1))},_scrollNext:function(){var t=this._visibleEnd();t<this._getTabs().size()&&this._scrollTab(-this._getTabsW(0,t+1)+this._getScrollBarW())},_scrollTab:function(t,e){var a=this;this._tabBox.animate({left:t+"px"},200,function(){a._ctrlScrollBut()})},_scrollCurrent:function(){var t=this._tabsW(this._getTabs());t<=this._getScrollBarW()?this._scrollTab(0):this._getLeft()<this._getScrollBarW()-t?this._scrollTab(this._getScrollBarW()-t):this._currentIndex<this._visibleStart()?this._scrollTab(-this._getTabsW(0,this._currentIndex)):this._currentIndex>=this._visibleEnd()&&this._scrollTab(this._getScrollBarW()-this._getTabs().eq(this._currentIndex).outerWidth(!0)-this._getTabsW(0,this._currentIndex))},_ctrlScrollBut:function(){var t=this._tabsW(this._getTabs());this._getScrollBarW()>t?(this._prevBut.hide(),this._nextBut.hide(),this._tabBox.parent().removeClass("tabsPageHeaderMargin")):(this._prevBut.show().removeClass("tabsLeftDisabled"),this._nextBut.show().removeClass("tabsRightDisabled"),this._tabBox.parent().addClass("tabsPageHeaderMargin"),this._getLeft()>=0?this._prevBut.addClass("tabsLeftDisabled"):this._getLeft()<=this._getScrollBarW()-t&&this._nextBut.addClass("tabsRightDisabled"))},_switchTab:function(t){var e=this._getTabs().removeClass("selected").eq(t).addClass("selected");this._getPanels().hide().eq(t).show(),this._getMoreLi().removeClass("selected").eq(t).addClass("selected"),this._currentIndex=t,this._scrollCurrent(),this._reload(e)},_closeTab:function(t){this._getTabs().eq(t).remove(),this._getPanels().eq(t).remove(),this._getMoreLi().eq(t).remove(),this._currentIndex>=t&&this._currentIndex--,this._init(),this._scrollCurrent(),this._reload(this._getTabs().eq(this._currentIndex))},closeTab:function(t){var e=this._indexTabId(t);e>0&&this._closeTab(e)},closeCurrentTab:function(){this._currentIndex>0&&this._closeTab(this._currentIndex)},closeAllTab:function(){this._getTabs().filter(":gt(0)").remove(),this._getPanels().filter(":gt(0)").remove(),this._getMoreLi().filter(":gt(0)").remove(),this._currentIndex=0,this._init(),this._scrollCurrent()},_closeOtherTab:function(t){if(t=t||this._currentIndex,t>0){var e=":eq("+t+")";this._getTabs().not(e).filter(":gt(0)").remove(),this._getPanels().not(e).filter(":gt(0)").remove(),this._getMoreLi().not(e).filter(":gt(0)").remove(),this._currentIndex=1,this._init(),this._scrollCurrent()}else this.closeAllTab()},_loadUrlCallback:function(t){t.find("[layoutH]").layoutH(),t.find(":button.close").click(function(){navTab.closeCurrentTab()})},_reload:function(t,e){e=e||t.data("reloadFlag");var a=t.attr("url");if(e&&a){t.data("reloadFlag",null);var i=this._getPanel(t.attr("tabid"));t.hasClass("external")?navTab.openExternal(a,i):i.loadUrl(a,{},function(){navTab._loadUrlCallback(i)})}},reloadFlag:function(t){var e=this._getTab(t);e&&(this._indexTabId(t)==this._currentIndex?this._reload(e,!0):e.data("reloadFlag",1))},reload:function(t,e){var a=$.extend({data:{},navTabId:"",callback:null},e),i=a.navTabId?this._getTab(a.navTabId):this._getTabs().eq(this._currentIndex),s=a.navTabId?this._getPanel(a.navTabId):this._getPanels().eq(this._currentIndex);s&&(t||(t=i.attr("url")),t&&(i.hasClass("external")?navTab.openExternal(t,s):s.ajaxUrl({type:"POST",url:t,data:a.data,callback:function(t){navTab._loadUrlCallback(s),$.isFunction(a.callback)&&a.callback(t)}})))},getCurrentPanel:function(){return this._getPanels().eq(this._currentIndex)},checkTimeout:function(){var t=DWZ.jsonEval(this.getCurrentPanel().html());t&&t.statusCode==DWZ.statusCode.timeout&&this.closeCurrentTab()},openExternal:function(t,e){var a=navTab._panelBox.height();e.html(DWZ.frag.externalFrag.replaceAll("{url}",t).replaceAll("{height}",a+"px"))},openTab:function(t,e,a){var i=$.extend({title:"New Tab",data:{},fresh:!0,external:!1},a),s=this._indexTabId(t);if(s>=0){var n=this._getTabs().eq(s),r=n.attr("tabid")==this._op.mainTabId?"> span > span":"> span";n.find(">a").attr("title",i.title).find(r).text(i.title);var l=this._getPanels().eq(s);(i.fresh||n.attr("url")!=e)&&(n.attr("url",e),i.external||e.isExternalUrl()?(n.addClass("external"),navTab.openExternal(e,l)):(n.removeClass("external"),l.ajaxUrl({type:"GET",url:e,data:i.data,callback:function(){navTab._loadUrlCallback(l)}}))),this._currentIndex=s}else{var o='<li tabid="#tabid#"><a href="javascript:" title="#title#"><span>#title#</span></a><a href="javascript:;" class="close">close</a></li>';this._tabBox.append(o.replace("#tabid#",t).replaceAll("#title#",i.title)),this._panelBox.append('<div class="page unitBox"></div>'),this._moreBox.append('<li><a href="javascript:" title="#title#">#title#</a></li>'.replaceAll("#title#",i.title));var c=this._getTabs(),n=c.filter(":last"),l=this._getPanels().filter(":last");i.external||e.isExternalUrl()?(n.addClass("external"),navTab.openExternal(e,l)):(n.removeClass("external"),l.ajaxUrl({type:"GET",url:e,data:i.data,callback:function(){navTab._loadUrlCallback(l)}})),$.History&&setTimeout(function(){$.History.addHistory(t,function(t){var e=navTab._indexTabId(t);e>=0&&navTab._switchTab(e)},t)},10),this._currentIndex=c.size()-1,this._contextmenu(c.filter(":last").hoverClass("hover"))}this._init(),this._scrollCurrent(),this._getTabs().eq(this._currentIndex).attr("url",e)}};