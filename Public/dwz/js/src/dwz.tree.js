!function($){$.extend($.fn,{jTree:function(options){var op=$.extend({checkFn:null,selected:"selected",exp:"expandable",coll:"collapsable",firstExp:"first_expandable",firstColl:"first_collapsable",lastExp:"last_expandable",lastColl:"last_collapsable",folderExp:"folder_expandable",folderColl:"folder_collapsable",endExp:"end_expandable",endColl:"end_collapsable",file:"file",ck:"checked",unck:"unchecked"},options);return this.each(function(){var $this=$(this),cnum=$this.children().length;$(">li",$this).each(function(){var e=$(this),t=e.prev()[0]?!1:!0,i=e.next()[0]?!1:!0;e.genTree({icon:$this.hasClass("treeFolder"),ckbox:$this.hasClass("treeCheck"),options:op,level:0,exp:cnum>1?t?op.firstExp:i?op.lastExp:op.exp:op.endExp,coll:cnum>1?t?op.firstColl:i?op.lastColl:op.coll:op.endColl,showSub:!$this.hasClass("collapse")&&($this.hasClass("expand")||(cnum>1?t?!0:!1:!0)),isLast:cnum>1?i?!0:!1:!0})}),setTimeout(function(){if($this.hasClass("treeCheck")){var checkFn=eval($this.attr("oncheck"));checkFn&&$.isFunction(checkFn)&&$("div.ckbox",$this).each(function(){var e=$(this);e.click(function(){var t=$(e).hasClass("checked"),i=[];if(t){var s=$(e).parent().parent(),c=$("input",s);c.size()>1?$(c).each(function(){i[i.length]={name:$(this).attr("name"),value:$(this).val(),text:$(this).attr("text")}}):i={name:c.attr("name"),value:c.val(),text:c.attr("text")}}checkFn({checked:t,items:i})})})}$("a",$this).click(function(e){$("div."+op.selected,$this).removeClass(op.selected);var t=$(this).parent().addClass(op.selected);return $(".ckbox",t).trigger("click"),e.stopPropagation(),$(document).trigger("click"),$(this).attr("target")?void 0:!1})},1)})},subTree:function(e,t){return this.each(function(){$(">li",this).each(function(){var i=$(this);setTimeout(function(){var s=i.next()[0]?!1:!0;i.genTree({icon:e.icon,ckbox:e.ckbox,exp:s?e.options.lastExp:e.options.exp,coll:s?e.options.lastColl:e.options.coll,options:e.options,level:t,space:s?null:e.space,showSub:e.showSub,isLast:s})},1)})})},genTree:function(e){function t(e,t){if(e>0){var i=t.parent().parent(),s=i.next()[0]?"line":"indent",c="<div class='"+s+"'></div>";if(e>1){for(var n=$(">div>div",i).filter(":first"),a="";e>1;)a=a+"<div class='"+n.attr("class")+"'></div>",n=n.next(),e--;c=a+c}$(">div",t).prepend(c)}}var i=$.extend({icon:e.icon,ckbox:e.ckbox,exp:"",coll:"",showSub:!1,level:0,options:null,isLast:!1},e);return this.each(function(){var e=$(this),s=$(">ul",e),c=e.parent().prev(),n="unchecked";i.ckbox&&$(">.checked",c).size()>0&&(n="checked"),s.size()>0?(e.children(":first").wrap("<div></div>"),$(">div",e).prepend("<div class='"+(i.showSub?i.coll:i.exp)+"'></div>"+(i.ckbox?"<div class='ckbox "+n+"'></div>":"")+(i.icon?"<div class='"+(i.showSub?i.options.folderColl:i.options.folderExp)+"'></div>":"")),i.showSub?s.show():s.hide(),$(">div>div:first,>div>a",e).click(function(){var t=$(">li:first",s);t.children(":first").isTag("a")&&s.subTree(i,i.level+1);var c=$(this),n=c.isTag("a"),c=n?$(">div>div",e).eq(i.level):c;return(!n||s.is(":hidden"))&&(c.toggleClass(i.exp).toggleClass(i.coll),i.icon&&$(">div>div:last",e).toggleClass(i.options.folderExp).toggleClass(i.options.folderColl)),s.is(":hidden")?s.slideDown("fast"):n?"":s.slideUp("fast"),!1}),t(i.level,e),i.showSub&&s.subTree(i,i.level+1)):(e.children().wrap("<div></div>"),$(">div",e).prepend("<div class='node'></div>"+(i.ckbox?"<div class='ckbox "+n+"'></div>":"")+(i.icon?"<div class='file'></div>":"")),t(i.level,e),i.isLast&&$(e).addClass("last")),i.ckbox&&e._check(i),$(">div",e).mouseover(function(){$(this).addClass("hover")}).mouseout(function(){$(this).removeClass("hover")}),$.browser.msie&&$(">div",e).click(function(){return $("a",this).trigger("click"),!1})})},_check:function(op){var node=$(this),ckbox=$(">div>.ckbox",node),$input=node.find("a"),tname=$input.attr("tname"),tvalue=$input.attr("tvalue"),attrs="text='"+$input.text()+"' ";tname&&(attrs+="name='"+tname+"' "),tvalue&&(attrs+="value='"+tvalue+"' "),ckbox.append("<input type='checkbox' style='display:none;' "+attrs+"/>").click(function(){var e=ckbox.hasClass("checked"),t=e?"unchecked":"checked",i=e?"checked":"unchecked";return ckbox.removeClass(i).removeClass(e?"":"indeterminate").addClass(t),$("input",ckbox).attr("checked",!e),$(">ul",node).find("li").each(function(){var s=$("div.ckbox",this);s.removeClass(i).removeClass(e?"":"indeterminate").addClass(t).find("input").attr("checked",!e)}),$(node)._checkParent(),!1});var cAttr=$input.attr("checked");cAttr&&(cAttr=eval(cAttr)),cAttr&&(ckbox.find("input").attr("checked",!0),ckbox.removeClass("unchecked").addClass("checked"),$(node)._checkParent())},_checkParent:function(){if(!$(this).parent().hasClass("tree")){var e=$(this).parent().parent(),t=$(">ul",e),i=t.find(">li>a").size()+t.find("div.ckbox").size(),s=t.find("div.checked").size(),c=s==i?"checked":0!=s?"indeterminate":"unchecked",n=s==i?"indeterminate":0!=s?"checked":"indeterminate";$(">div>.ckbox",e).removeClass("unchecked").removeClass("checked").removeClass(n).addClass(c),e._checkParent()}}})}(jQuery);